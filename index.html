<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Untitled</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>

<head>
<meta charset="UTF-8">
<title>RentelBike</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* --- General Styles (V2.7 - Orange-Green Mix Background) --- */
body{
  margin:0;
  font-family:Arial, sans-serif;
  /* üé® ‡§™‡•Ç‡§∞‡•á ‡§¨‡•â‡§°‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§≤‡•ç‡§ï‡§æ ‡§®‡§æ‡§∞‡§Ç‡§ó‡•Ä-‡§π‡§∞‡§æ ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü (Light Peach to Light Mint) */
  background: linear-gradient(to bottom, #ffedd5 0%, #dcfce7 100%); 
  min-height: 100vh;
}
header{background:#0f172a;color:#fff;padding:14px;text-align:center;font-weight:bold; position: fixed; top: 0; width: 100%; z-index: 10;}

.page{
  display:none;
  padding:15px;
  padding-bottom:90px;
  min-height: calc(100vh - 40px); 
  box-sizing: border-box; 
  position: absolute; 
  top: 40px; 
  left: 0;
  width: 100%;
  /* üé® ‡§™‡•á‡§ú ‡§ï‡•ã body ‡§ï‡•á ‡§ó‡•ç‡§∞‡•á‡§°‡§ø‡§è‡§Ç‡§ü ‡§∏‡•á ‡§•‡•ã‡§°‡§º‡§æ ‡§Ö‡§≤‡§ó ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§≤‡•ç‡§ï‡§æ ‡§∞‡§Ç‡§ó */
  background: #f0fdf4; 
}
.page.active{display:block}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
input,select,textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;margin-top:8px;box-sizing:border-box}
button{width:100%;padding:12px;border:none;border-radius:6px;margin-top:10px;font-weight:bold}
.green{background:#22c55e;color:#fff}
.gray{background:#64748b;color:#fff}
.blue{background:#3b82f6;color:#fff} 
.red{background:#ef4444;color:#fff;}

/* --- Navigation Styles --- */
nav{
  position:fixed;
  bottom:0;
  width:100%;
  display:none; 
  background:#fff;
  border-top:1px solid #ccc;
  z-index: 10;
}
body.logged-in nav { 
  display: flex; 
}
nav button{flex:1;background:#fff;border:none;padding:10px;font-size:14px}
.profile-item{padding:14px;border-bottom:1px solid #eee;cursor:pointer}
small{font-size:11px;color:#6b7280}

/* --- Image and Slider Styles --- */
.img-slider{display:flex;gap:8px;overflow-x:auto;margin-bottom:10px}
.img-slider img{
  width:90%; 
  min-width: 90%; 
  height: 150px;
  object-fit:cover;
  border-radius:10px
}

/* Admin KYC/Bike Image Row */
.admin-img-row {
    display: flex;
    overflow-x: auto;
    gap: 5px;
}
.admin-img-row img {
    width: 80px; 
    min-width: 80px; 
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    cursor: zoom-in;
}

/* --- Login Page Background (Updated) --- */
#login {
    background-image: url('https://via.placeholder.com/1080x1920?text=RentelBike+Login+BG'); 
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    display: flex; 
    justify-content: center;
    align-items: center;
    height: 100vh; 
    padding-top: 0;
    top: 0; 
    padding-bottom: 0;
    background-color: transparent; 
}

#login .card {
    background: rgba(255, 255, 255, 0.9); 
    padding: 20px;
    width: 90%;
    max-width: 350px;
}

/* --- New Zoom Overlay Styles V2.7 --- */
#image-zoom-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9); /* Dark semi-transparent background */
    z-index: 9999;
    align-items: center;
    justify-content: center;
    cursor: zoom-out; /* Indicate it can be closed */
}

#zoomed-img {
    max-width: 90%;
    max-height: 90%;
    transform: scale(1);
    transition: transform 0.3s ease-out;
    cursor: grab;
}

.card img, .img-slider img {
    cursor: zoom-in; /* Indicate it can be zoomed */
}
</style>
</head>

<body>
<header>RentelBike</header>

<div id="login" class="page active">
  <div class="card">
    <h3>Login</h3>
    <input id="lphone" placeholder="Mobile" maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <input id="lpass" placeholder="Password / OTP" type="password">
    <button class="green" onclick="login()">Login</button>
    <button class="blue" onclick="openPage('signupForm')">New User? Sign Up</button> 
    <button class="gray" onclick="guestLogin()">Skip for now</button>
    
    <button class="red" onclick="openPage('forgotPass')">Forgot Password?</button>
    
  </div>
</div>

<div id="forgotPass" class="page">
    <div class="card">
        <h3>Forgot Password</h3>
        <input id="fphone" placeholder="Mobile Number *" maxlength="10"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        
        <div id="forgotOtpBox" style="display:block;">
             <button class="blue" onclick="sendForgotOtp()">Send OTP</button>
        </div>
        
        <div id="forgotOtpVerifyBox" style="display:none;">
            <input id="fotp" placeholder="Enter OTP" maxlength="6"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <button class="green" onclick="verifyForgotOtp()">Verify OTP</button>
        </div>
        
        <input id="fpass" placeholder="Set New Password *" type="password" style="display:none;">
        <button class="green" id="setPassBtn" onclick="setNewPassword()" style="display:none;">Set New Password</button>
        
        <button class="gray" onclick="openPage('login')">‚Üê Back to Login</button> 
    </div>
</div>

<div id="signupForm" class="page">
    <div class="card">
        <h3>Create Account</h3>
        <input id="sname" placeholder="Full Name *">
        <label>Date of Birth * (Must be 18+)</label>
        <input type="date" id="sdob">
        <input id="semail" placeholder="Email (Optional)">
        <input id="sreferral" placeholder="Referral Code (Optional)">
        
        <label>Mobile Verification *</label>
        <input id="sphone" placeholder="Mobile *" maxlength="10"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="otpBox" style="display:block;">
             <button class="blue" onclick="sendOtp()">Send OTP</button>
        </div>
        
        <div id="otpVerifyBox" style="display:none;">
            <input id="sotp" placeholder="Enter OTP" maxlength="6"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')">
            <button class="green" onclick="verifyOtp()">Verify OTP</button>
        </div>
        
        <input id="spass" placeholder="Set Password *" type="password" style="display:none;">
        <button class="green" id="signupBtn" onclick="signup()" style="display:none;">Sign Up & Complete</button>
        <button class="gray" onclick="openPage('login')">‚Üê Back to Login</button> 
    </div>
</div>

<div id="home" class="page">
  <div class="card">
    <h3>Dashboard</h3>
    <button class="green" onclick="openPage('explore')">Explore Bikes</button>
    <button class="green" onclick="checkAuth('listbike')">List a Bike</button>
    
    <div id="adminButtons" style="display: none;">
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
        <h4 style="color:#ef4444; margin-bottom: 5px;">Admin Panel</h4>
        <button class="red" onclick="openAdminLogin('admin')">Admin Bike Panel</button>
        <button class="red" onclick="openAdminLogin('adminKYC')">Admin KYC Panel</button>
        <button class="red" onclick="openAdminLogin('adminSupport')">Admin Support Panel</button> 
    </div>
  </div>
</div>

<div id="listbike" class="page">
  <div class="card">
    <h3>List Bike</h3>
    <input id="ownerName" placeholder="Owner Name *">
    <input id="ownerPhone" placeholder="Owner Phone *" maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <input id="bikeName" placeholder="Bike Name *">
    
    <select id="bikeFuelType">
        <option value="">Select Fuel Type *</option>
        <option value="Petrol">Petrol</option>
        <option value="Electric">Electric</option>
        <option value="Diesel">Diesel (Heavy Bikes/Scooters)</option>
    </select>
    
    <input id="bikeRegNo" placeholder="Bike Registration Number (e.g., UP65AA1234) *" style="text-transform:uppercase;">
    
    <select id="bikeState">
        <option value="">Select State *</option>
        <option value="DL">Delhi</option>
        <option value="UP">Uttar Pradesh</option>
        <option value="MH">Maharashtra</option>
        <option value="KA">Karnataka</option>
    </select>
    <input id="bikeCity" placeholder="City *">
    
    <input id="rentDay" placeholder="Rent per Day *" type="number">
    <label>Bike Expiry *</label>
    <input type="date" id="bikeExpiry">

    <label>RC Photo * (Camera Only - Admin will review)</label><input type="file" id="imgRC" accept="image/*" capture="camera">

    <label>Front Photo * (Camera Only)</label><input type="file" id="imgFront" accept="image/*" capture="camera">
    <label>Back Photo * (Camera Only)</label><input type="file" id="imgBack" accept="image/*" capture="camera">
    <label>Left Photo * (Camera Only)</label><input type="file" id="imgLeft" accept="image/*" capture="camera">
    <label>Right Photo * (Camera Only)</label><input type="file" id="imgRight" accept="image/*" capture="camera">

    <button class="blue" id="getLocationBtn" onclick="captureLocation()">Capture Current Location (Mandatory)</button>
    <p style="font-size:12px; color:#3b82f6; margin-top:5px;" id="locationStatus">Location not captured.</p>

    <button class="green" onclick="submitBike()">Submit</button>
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="explore" class="page">
  <div id="bikeList"></div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="detail" class="page">
  <div class="card">
    <div class="img-slider">
      <img id="pf" alt="Front Photo">
      <img id="pb" alt="Back Photo">
      <img id="pl" alt="Left Photo">
      <img id="pr" alt="Right Photo">
    </div>
    <h3 id="dBike"></h3>
    <p style="margin:2px 0; font-size:14px; color:#3b82f6;">Reg No: <span id="dRegNo"></span></p> 
    <p style="margin:2px 0;">Fuel Type: <span id="dFuelType"></span></p> <p style="margin:2px 0;">Location: <span id="dState"></span>, <span id="dCity"></span></p> 
    ‚Çπ<span id="dRate"></span>/day
    <div style="margin:10px 0;display:flex;justify-content:space-between;align-items:center">
      <button class="gray" onclick="changeDays(-1)">‚àí</button>
      <b><span id="days">1</span> Day(s)</b>
      <button class="gray" onclick="changeDays(1)">+</button>
    </div>
    <p>Total: ‚Çπ<span id="totalAmt"></span></p>
    <button class="green" onclick="checkAuthAndRent()">Rent Now</button> 
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="verify" class="page">
    <div class="card">
        <h3>Verify Rental Details</h3>
        <p>You are about to rent: <b><span id="vBikeName"></span></b></p>
        <p>Total Days: <span id="vDays"></span>, Total Amount: ‚Çπ<span id="vAmount"></span></p>

        <h4>User Verification (To be done once)</h4>
        <input id="vname" placeholder="Full Name (Mandatory)" value="Test User">
        <input id="vphone" placeholder="Mobile (Mandatory)" value="9998887770" maxlength="10">
        <input id="vaad" placeholder="Aadhaar Number (12 Digits)" value="123456789012" maxlength="12">
        <input id="vpan" placeholder="PAN Number (Mandatory)" value="ABCDE1234F">
        <input id="vdl" placeholder="Driving Licence Number (Mandatory)" value="DL123456789">

        <button class="green" onclick="verifyRentalData()">Proceed to Payment</button>
        <button class="gray" onclick="back()">‚Üê Back</button>
    </div>
</div>

<div id="payment" class="page">
    <div class="card">
        <h3>Payment</h3>
        <p style="font-size: 18px;">Amount Due: ‚Çπ<b id="payAmount">0.00</b></p>

        <label>Payment Mode:</label>
        <select id="payMode" onchange="showPay()">
            <option value="">-- Select --</option>
            <option value="wallet">Wallet Balance</option>
            <option value="upi">UPI</option>
            <option value="card">Credit/Debit Card</option>
        </select>

        <div id="walletBox" style="display:none; margin-top:10px;">
            Wallet Balance: ‚Çπ<b id="walletBal">0.00</b>
        </div>

        <div id="upiBox" style="display:none; margin-top:10px;">
            <input id="upiId" placeholder="Enter UPI ID (e.g., name@bank)" value="user@upi">
        </div>

        <div id="cardBox" style="display:none; margin-top:10px;">
            <input id="cardNo" placeholder="Card Number" value="4111222233334444" maxlength="16">
            <div style="display:flex; gap:10px;">
                <input id="cardExp" placeholder="MM/YY" style="width:50%;" value="12/28" maxlength="5">
                <input id="cardCvv" placeholder="CVV" style="width:50%;" value="123" maxlength="3">
            </div>
        </div>
        
        <button class="green" onclick="pay()">Pay Now</button>
        <button class="gray" onclick="back()">‚Üê Back</button>
    </div>
</div>

<div id="completeKYC" class="page">
    <div class="card">
        <h3>Complete KYC</h3>
        <p style="color:#ef4444; font-size:12px;">KYC is required to rent a bike.</p>
        
        <label>Aadhaar Front (Camera Only)</label><input type="file" id="aadFront" accept="image/*" capture="camera">
        <label>Aadhaar Back (Camera Only)</label><input type="file" id="aadBack" accept="image/*" capture="camera">
        <label>PAN Card (Camera Only)</label><input type="file" id="panFront" accept="image/*" capture="camera">
        <label>Driving Licence (Camera Only)</label><input type="file" id="dlFront" accept="image/*" capture="camera">
        
        <button class="green" onclick="submitKYC()">Submit KYC Documents</button>
        <button class="gray" onclick="back()">‚Üê Back</button>
    </div>
</div>

<div id="profile" class="page">
  <div class="card">
    <b>Logged in:</b> <span id="pPhone"></span><br>
    <b>Name:</b> <span id="pName"></span><br>
    <b>Wallet Balance:</b> ‚Çπ<span id="pWallet"></span>
  </div>

  <div class="profile-item" onclick="openWallet()">üí∞ Wallet</div>
  <div class="profile-item" onclick="openTxns()">üìú Transaction History</div>
  <div class="profile-item" onclick="openInvoices()">üßæ Invoices</div>
  <div class="profile-item" onclick="openRentals()">üèç Rental History</div>
  <div class="profile-item" onclick="openListed()">üìã Your Listed Bikes</div>

  <div class="profile-item" onclick="openCompleteKYC()">
    ‚úÖ Complete KYC :
    <b id="kycStatusText"></b>
    <div id="kycRejectReason" style="font-size:12px; color:red;"></div>
  </div>

  <div class="profile-item" onclick="openPage('subscription')">üí≥ Subscription</div>
  <div class="profile-item" onclick="openAddressPage()">üìç Saved Address</div>
  <div class="profile-item" onclick="openPage('securityPage')">üîí Security Deposit</div>
  <div class="profile-item" onclick="openNotifs()">üîî Notifications</div>
  <div class="profile-item" onclick="openPage('about')">‚Ñπ About Us</div>
  
  <div class="profile-item" onclick="openPage('supportForm')">üìû Help & Support</div> 

  <div class="profile-item" onclick="logout()" style="color:red">üö™ Logout</div>
</div>

<div id="walletPage" class="page">
  <div class="card">
    <h3>Wallet</h3>
    Balance: ‚Çπ<b id="walletShow"></b>
    <button class="green" onclick="openPage('walletRecharge')">‚ûï Add Funds (Recharge)</button>
    <button class="red" onclick="openPage('walletWithdraw')">‚ûñ Withdraw Funds</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="walletRecharge" class="page">
  <div class="card">
    <h3>Add Funds (UPI)</h3>
    <input id="reAmt" placeholder="Amount">
    <input id="reUpi" placeholder="your@upi">
    <button class="green" onclick="recharge()">Recharge Now</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="walletWithdraw" class="page">
  <div class="card">
    <h3>Withdraw Funds</h3>
    Balance: ‚Çπ<b id="withdrawWalletShow"></b>
    <input id="wiAmt" placeholder="Amount to Withdraw" type="number">
    <input id="wiAcc" placeholder="Bank Account Number">
    <input id="wiIfsc" placeholder="IFSC Code">
    <button class="red" onclick="withdraw()">Submit Withdrawal Request</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>


<div id="addressPage" class="page">
  <div class="card">
    <h3>Saved Address</h3>
    <div id="savedAddressDisplay"></div>

    <h4 style="margin-top:20px;">Add / Update Address</h4>
    <input id="addrLine1" placeholder="Address Line 1 *">
    <input id="addrLine2" placeholder="Address Line 2 (Optional)">
    <input id="addrCity" placeholder="City *">
    <input id="addrPin" placeholder="Pincode *" maxlength="6"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <button class="green" onclick="saveAddress()">Save Address</button>
    <button class="red" id="deleteAddressBtn" onclick="deleteAddress()" style="display:none;">Delete Address</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="txnPage" class="page">
  <div class="card">
    <h3>Transactions</h3>
    <div id="txnList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="invoicePage" class="page">
  <div class="card">
    <h3>Invoices</h3>
    <div id="invList"></div>
    <button class="green" onclick="downloadInvoice()">Download Last Invoice (Print)</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="rentalHistory" class="page">
  <div class="card">
    <h3>Your Rentals</h3>
    <div id="rentalList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>
  <!-- ================= BIKE RETURN SECTION ================= -->
<d

<div id="listedBikes" class="page">
  <div class="card">
    <h3>Your Listed Bikes</h3>
    <div id="listedList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="subscription" class="page">
  <div class="card">
    <h3>Subscription</h3>
    <p>‚Çπ100 / month ‚Äî unlock owner contact details (demo)</p>
    <button class="green" onclick="alert('Demo only ‚Äì real subscription needs backend')">Subscribe</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="securityPage" class="page">
  <div class="card">
    <h3>Security Deposit</h3>
    <p>Default deposit policy managed by platform (demo).</p>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="notifPage" class="page">
  <div class="card">
    <h3>Notifications</h3>
    <div id="notifList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="about" class="page">
  <div class="card" style="margin-bottom: 0;">
    <div style="background: linear-gradient(to right, #22c55e, #3b82f6); color: #fff; padding: 15px; text-align: center; border-radius: 10px 10px 0 0;">
      <h3>RentelBike</h3>
      <p style="margin: 0;">Bike Rental Platform</p>
    </div>
    <h3 style="margin-top: 15px; text-align: center;">Our Team</h3>
  </div>
  
  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px; overflow: hidden;">
      <img src="https://via.placeholder.com/100x100?text=Shivam" 
           alt="Shivam Pal" 
           style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
    </div>
    <h4 style="margin: 0;">Shivam Pal</h4>
    <p style="color: #22c55e; margin: 0;">Founder & Director</p>
    <p style="margin: 5px 0 0;">üìû 9336231919</p>
  </div>

  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px; overflow: hidden;">
      <img src="https://via.placeholder.com/100x100?text=Rishikesh" 
           alt="Rishikesh Yadav" 
           style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
    </div>
    <h4 style="margin: 0;">Rishikesh Yadav</h4>
    <p style="color: #22c55e; margin: 0;">CEO</p>
    <p style="margin: 5px 0 0;">üìû 8866271441</p>
  </div>

  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px; overflow: hidden;">
      <img src="https://via.placeholder.com/100x100?text=Utkarsh" 
           alt="Utkarsh" 
           style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
    </div>
    <h4 style="margin: 0;">Utkarsh</h4>
    <p style="color: #22c55e; margin: 0;">Co-Founder</p>
    <p style="margin: 5px 0 0;">üìû 7800300325</p>
  </div>

  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px;">
      <img src="https://via.placeholder.com/100x100?text=Sahil" 
           alt="Sahil Gupta" 
           style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
    </div>
    <h4 style="margin: 0;">Sahil Gupta</h4>
    <p style="color: #22c55e; margin: 0;">Support Head</p>
    <p style="margin: 5px 0 0;">üìû (Not Fully Visible)</p>
  </div>
  
  <button class="gray" onclick="back()">‚Üê Back to Profile</button>
</div>

<div id="support" class="page">
  <div class="card">
    <h3>Contact Info</h3>
    <p>Email: support@rentelbike.com</p>
    <p>Phone: +91-9000000000</p>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="supportForm" class="page">
    <div class="card">
        <h3>Help & Support Form</h3>
        <p style="font-size:12px; color:#64748b;">Please enter your details and describe your issue.</p>
        
        <label>Your Name</label>
        <input id="supportName" placeholder="Your Name" value="Test User">
        
        <label>Email ID *</label>
        <input id="supportEmail" placeholder="Email ID" type="email" value="test@example.com">
        
        <label>Mobile Number *</label>
        <input id="supportPhone" placeholder="Mobile (10 digits)" maxlength="10"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')" value="9998887770">
        
        <label>Your Message *</label>
        <textarea id="supportMessage" placeholder="Describe your issue in detail..." style="height:100px;"></textarea>

        <button class="green" onclick="submitSupportRequest()">Submit Request</button>
        <button class="gray" onclick="back()">‚Üê Back</button>
    </div>
</div>

<div id="admin" class="page">
  <div class="card"><h3>Admin Bike Approval & Deletion</h3></div>
  <div id="adminList"></div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="adminKYC" class="page">
  <div class="card">
    <h3>Admin ‚Äì User Review & Control</h3> 
    <p>Current Status: <b id="adminKycState"></b></p>
    
    <label>KYC Reject Reason (Required for Reject)</label>
    <textarea id="rejectReason" placeholder="Reject reason (required for reject)"
      style="width:100%;height:70px; margin-bottom: 10px;"></textarea>
    
    <div id="kycAdminButtons">
        </div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="adminSupport" class="page">
  <div class="card"><h3>Admin ‚Äì Support Requests</h3></div>
  <div id="supportList"></div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="adminLogin" class="page">
  <div class="card">
    <h3>Admin Login</h3>
    <input id="adminPhone" placeholder="Admin Phone">
    <input id="adminPass" type="password" placeholder="Admin Password">
    <button class="green" onclick="adminLogin()">Login as Admin</button>
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="image-zoom-overlay" onclick="closeZoom()">
    <img id="zoomed-img" src="" alt="Zoomed Image">
</div>

<nav>
  <button onclick="openPage('home')">üè† Home</button>
  <button onclick="openPage('explore')">üõµ Bikes</button>
  <button onclick="checkAuth('profile')">üë§ Profile</button> 
</nav>

<script>
// ====== STATE AND DATA MANAGEMENT ======
let stack = [];
let bikes = JSON.parse(localStorage.getItem('bikes') || '[]');
if (bikes.length === 0) {
    bikes = [
        {
            id: 1672531200001, owner: "9876543210", ownerName: "Dummy Owner 1", ownerPhone: "9876543210", 
            bikeName: "Hero Splendor Pro", 
            fuelType: "Petrol", 
            bikeRegNo: "UP65AA1234", rent: 350, expiry: "2026-12-31",
            state: "UP", city: "Lucknow", 
            coords: {lat: 26.8467, lon: 80.9462}, 
            images: {front: "https://via.placeholder.com/300x150?text=Splendor+Front", back: "https://via.placeholder.com/300x150?text=Splendor+Back", left: "https://via.placeholder.com/300x150?text=Splendor+Left", right: "https://via.placeholder.com/300x150?text=Splendor+Right", rc: "https://via.placeholder.com/300x150?text=Splendor+RC"}, 
            status: 'approved' 
        },
        {
            id: 1672531200002, owner: "9876543210", ownerName: "Dummy Owner 2", ownerPhone: "9876543210", 
            bikeName: "Honda Activa 6G", 
            fuelType: "Petrol", 
            bikeRegNo: "DL05BB5678", rent: 300, expiry: "2026-11-30",
            state: "DL", city: "New Delhi", 
            coords: {lat: 28.7041, lon: 77.1025}, 
            images: {front: "https://via.placeholder.com/300x150?text=Activa+Front", back: "https://via.placeholder.com/300x150?text=Activa+Back", left: "https://via.placeholder.com/300x150?text=Activa+Left", right: "https://via.placeholder.com/300x150?text=Activa+Right", rc: "https://via.placeholder.com/300x150?text=Activa+RC"}, 
            status: 'approved'
        }
    ];
    try { localStorage.setItem('bikes', JSON.stringify(bikes)); } catch(e) { console.error("Initial dummy bike save failed:", e.message); }
}

let currentBikeIndex = null;
let days = 1;
let kycData = JSON.parse(localStorage.getItem('kycData') || 'null'); 
let users = JSON.parse(localStorage.getItem('users') || '[]');
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null'); 
let wallet = currentUser && !currentUser.isGuest ? currentUser.wallet : Number(localStorage.getItem('wallet') || '5000'); 
let transactions = JSON.parse(localStorage.getItem('txns') || '[]');
let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
let rentals = JSON.parse(localStorage.getItem('rentals') || '[]');
let notifs = JSON.parse(localStorage.getItem('notifs') || '[]');
let kycStatus = localStorage.getItem("kycStatus") || "none";
let kycReason = localStorage.getItem("kycReason") || "";
let kycSubmittedAt = Number(localStorage.getItem("kycSubmittedAt" || 0));
let userAddress = JSON.parse(localStorage.getItem('userAddress') || 'null'); 

// V2.9: New Support Request Array
let supportRequests = JSON.parse(localStorage.getItem('supportRequests') || '[]'); 
if (supportRequests.length === 0) {
    supportRequests = [
        {id: 1, name: "Sahil Gupta", email: "sahil@test.com", phone: "9876543210", 
         message: "My wallet recharge failed but money was deducted.", 
         date: new Date().toLocaleString(), status: 'new'}
    ];
}


const ADMIN_PHONE = "9336231919";      
// V2.12: Admin password is now fixed and strong, not linked to any user reset
const ADMIN_PASS  = "RentelBike@ADM!N2025";     

let currentOTP = null;
let otpPhone = null;

// V2.14: Forgot Password State
let forgotPassOTP = null;
let forgotPassPhone = null;


let capturedLocation = null; 

function saveAll(){
  try {
    if(currentUser && !currentUser.isGuest) {
        const userIndex = users.findIndex(u => u.phone === currentUser.phone);
        if (userIndex !== -1) {
            users[userIndex] = currentUser;
        }
    }
    
    localStorage.setItem('bikes', JSON.stringify(bikes));
    localStorage.setItem('txns', JSON.stringify(transactions));
    localStorage.setItem('invoices', JSON.stringify(invoices));
    localStorage.setItem('rentals', JSON.stringify(rentals));
    localStorage.setItem('notifs', JSON.stringify(notifs));
    localStorage.setItem('kycStatus', kycStatus);
    localStorage.setItem('kycReason', kycReason);
    localStorage.setItem('kycSubmittedAt', kycSubmittedAt);
    localStorage.setItem('kycData', JSON.stringify(kycData)); 
    localStorage.setItem('users', JSON.stringify(users));
    
    if(currentUser && currentUser.isGuest) {
        localStorage.setItem('wallet', wallet);
        currentUser.wallet = wallet; 
    }
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    localStorage.setItem('userAddress', JSON.stringify(userAddress));
    
    // V2.9: Save Support Requests
    localStorage.setItem('supportRequests', JSON.stringify(supportRequests));
    
  } catch(e) {
    if (e.name === 'QuotaExceededError') {
      alert("Error saving data: Failed to execute 'setItem'. Local Storage quota exceeded. You may lose current unsaved data.");
      console.error(e.message);
    } else {
      alert("Error saving data: " + e.message);
      console.error(e.message);
    }
  }
}

function addNotif(msg){
  notifs.push({msg,date:new Date().toLocaleString()});
  saveAll();
}

function getBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// ====== PAGE NAVIGATION & AUTHENTICATION (V2.11: renderHome Added) ======

function renderHome() {
    const adminBtns = document.getElementById('adminButtons');
    
    // Check if user is logged in and their phone matches the Admin phone
    if (currentUser && currentUser.phone === ADMIN_PHONE) {
        adminBtns.style.display = 'block'; // Show buttons
    } else {
        adminBtns.style.display = 'none'; // Hide buttons for everyone else
    }
}

function isLoggedIn() {
    return currentUser && !currentUser.isGuest;
}

function toggleNav(show) {
    if (show) {
        document.body.classList.add('logged-in');
    } else {
        document.body.classList.remove('logged-in');
    }
}

function checkAuth(targetPage){
    if (isLoggedIn()) {
        openPage(targetPage);
    } else {
        alert("Please Login or Sign Up to access this feature.");
        stack = [];
        openPage('login');
    }
}

function openPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const targetPage = document.getElementById(id);
  if(targetPage) targetPage.classList.add('active');
  
  const lastInStack = stack[stack.length - 1];
  if (id === 'login' || id === 'signupForm' || id === 'forgotPass') { // V2.14: Forgot Pass added
      stack = [id]; 
  } else if (lastInStack !== id) {
      stack.push(id);
  }

  if (id === 'login' || id === 'signupForm' || id === 'adminLogin' || id === 'forgotPass') { // V2.14: Forgot Pass added
      toggleNav(false);
      if(id === 'login' || id === 'signupForm' || id === 'forgotPass') document.querySelector('header').style.display = 'none'; // V2.14: Hide header on auth pages
  } else {
      toggleNav(true); 
      document.querySelector('header').style.display = 'block';
  }

  // Page-specific render functions
  if(id === 'home') renderHome(); // V2.11: Add Home Render for security check
  if(id === 'explore') renderBikes(); 
  if(id === 'profile') renderProfile();
  if(id === 'admin') renderAdminBikes();
  if(id === 'adminKYC') renderAdminKYC();
  if(id === 'adminSupport') renderAdminSupport(); // V2.9: New Admin Render
  if(id === 'walletPage') walletShow.innerText = (currentUser ? currentUser.wallet : wallet).toFixed(2);
  if(id === 'walletWithdraw') withdrawWalletShow.innerText = (currentUser ? currentUser.wallet : wallet).toFixed(2);
  if(id === 'txnPage') renderTxns();
  if(id === 'rentalHistory') renderRentals();
  if(id === 'listedBikes') renderListedBikes();
  if(id === 'notifPage') renderNotifs();
  if(id === 'signupForm') resetSignupForm();
  if(id === 'listbike') resetListBikeForm();
  if(id === 'invoicePage') renderInvoices(); 
  
  // V2.7: Set up zoom functionality for all images on the page
  setupZoomableImages(); 
}

function resetListBikeForm() {
    capturedLocation = null;
    document.getElementById('locationStatus').innerText = 'Location not captured.';
    document.getElementById('getLocationBtn').classList.remove('green');
    document.getElementById('getLocationBtn').classList.add('blue');
    document.getElementById('getLocationBtn').innerText = 'Capture Current Location (Mandatory)';
}


function back(){
  stack.pop(); 
  let prevPageId = stack.pop(); 
  if(prevPageId) openPage(prevPageId);
  else openPage('home'); 
}

function renderProfile(){
    if(currentUser){
        pPhone.innerText = currentUser.phone || (currentUser.isGuest ? 'Guest' : 'N/A');
        pName.innerText = currentUser.name || (currentUser.isGuest ? 'Guest' : 'N/A');
        pWallet.innerText = currentUser.wallet !== undefined ? currentUser.wallet.toFixed(2) : wallet.toFixed(2);
        
        kycStatusText.innerText = kycStatus.toUpperCase();
        kycStatusText.style.color = kycStatus === 'approved' ? '#22c55e' : (kycStatus === 'pending' ? '#3b82f6' : '#dc3545');

        kycRejectReason.innerText = kycStatus === 'rejected' ? `Reason: ${kycReason}` : '';
        kycRejectReason.style.display = kycStatus === 'rejected' ? 'block' : 'none';
        
    } else {
         pPhone.innerText = 'N/A';
         pName.innerText = 'N/A';
         pWallet.innerText = wallet.toFixed(2);
         kycStatusText.innerText = 'N/A';
         kycRejectReason.style.display = 'none';
    }
}

// ====== SIGNUP / OTP / LOGIN LOGIC (UNCHANGED) ======
function resetSignupForm() {
    document.getElementById('sname').value = '';
    document.getElementById('sdob').value = '';
    document.getElementById('semail').value = '';
    document.getElementById('sreferral').value = '';
    document.getElementById('sphone').value = '';
    document.getElementById('sotp').value = '';
    document.getElementById('spass').value = '';
    document.getElementById('otpBox').style.display = 'block';
    document.getElementById('otpVerifyBox').style.display = 'none';
    document.getElementById('spass').style.display = 'none';
    document.getElementById('signupBtn').style.display = 'none';
}
function sendOtp(){
    const phone = document.getElementById('sphone').value;
    if (phone.length !== 10) { alert("Please enter a valid 10-digit mobile number."); return; }
    
    // Check Age (must be 18+)
    const dobInput = document.getElementById('sdob').value;
    if (!dobInput) { alert("Please select your Date of Birth."); return; }
    const birthDate = new Date(dobInput);
    const today = new Date();
    const age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    if (age < 18) {
        alert("You must be 18 years or older to sign up.");
        return;
    }
    
    otpPhone = phone;
    currentOTP = Math.floor(100000 + Math.random() * 900000); // 6-digit OTP
    alert(`OTP sent to ${phone}: ${currentOTP} (Demo Only)`);
    document.getElementById('otpBox').style.display = 'none';
    document.getElementById('otpVerifyBox').style.display = 'block';
}

function verifyOtp() {
    const enteredOTP = document.getElementById('sotp').value;
    if (enteredOTP === currentOTP.toString()) {
        alert("OTP Verified Successfully!");
        document.getElementById('otpVerifyBox').style.display = 'none';
        document.getElementById('spass').style.display = 'block';
        document.getElementById('signupBtn').style.display = 'block';
    } else {
        alert("Invalid OTP. Please try again.");
    }
}

function signup() {
    const name = document.getElementById('sname').value;
    const phone = document.getElementById('sphone').value;
    const password = document.getElementById('spass').value;
    const dob = document.getElementById('sdob').value;

    if (!name || !phone || !password || !dob) {
        alert("Please fill all required fields.");
        return;
    }

    if (users.some(u => u.phone === phone)) {
        alert("User already exists with this mobile number. Please log in.");
        openPage('login');
        return;
    }

    const newUser = {
        name,
        phone,
        password,
        dob,
        email: document.getElementById('semail').value,
        referral: document.getElementById('sreferral').value,
        wallet: 0.00,
        txns: [],
        rentals: [],
        listedBikes: [],
        isBanned: false // V2.15: Ban status added
    };
    users.push(newUser);
    currentUser = newUser;
    localStorage.setItem('kycStatus', 'none'); 
    kycStatus = 'none'; 
    saveAll();
    alert("Sign up successful! Please complete your KYC.");
    openPage('home');
}

// V2.15: Login function updated to check for BAN status
function login() {
    const phone = document.getElementById('lphone').value;
    const pass = document.getElementById('lpass').value;

    const user = users.find(u => u.phone === phone && u.password === pass);

    if (user) {
        if (user.isBanned) { // V2.15: Check for banned status
            alert("This account has been BANNED by the Admin. Please contact support.");
            return;
        }

        currentUser = user;
        kycStatus = localStorage.getItem("kycStatus") || 'none'; 
        kycData = JSON.parse(localStorage.getItem('kycData') || 'null');
        kycReason = localStorage.getItem("kycReason") || "";
        kycSubmittedAt = Number(localStorage.getItem("kycSubmittedAt") || 0);

        // Fetch user specific data
        const userKycStatus = localStorage.getItem(`kycStatus_${phone}`);
        if(userKycStatus) kycStatus = userKycStatus;
        
        alert("Login successful!");
        openPage('home');
    } else {
        alert("Invalid mobile or password.");
    }
}

// ====== FORGOT PASSWORD LOGIC (V2.14: NEW) ======

function sendForgotOtp() {
    const phone = document.getElementById('fphone').value;
    if (phone.length !== 10) { alert("Please enter a valid 10-digit mobile number."); return; }
    
    // Check if user exists
    const user = users.find(u => u.phone === phone);
    if (!user) {
        alert("User not found with this mobile number. Please Sign Up.");
        // openPage('signupForm'); // Uncomment if you want to redirect
        return;
    }
    
    forgotPassPhone = phone;
    forgotPassOTP = Math.floor(100000 + Math.random() * 900000); // 6-digit OTP
    alert(`OTP sent to ${phone}: ${forgotPassOTP} (Demo Only)`);
    
    document.getElementById('forgotOtpBox').style.display = 'none';
    document.getElementById('forgotOtpVerifyBox').style.display = 'block';
}

function verifyForgotOtp() {
    const enteredOTP = document.getElementById('fotp').value;
    if (enteredOTP === forgotPassOTP.toString()) {
        alert("OTP Verified Successfully! Please set your new password.");
        document.getElementById('forgotOtpVerifyBox').style.display = 'none';
        document.getElementById('fpass').style.display = 'block';
        document.getElementById('setPassBtn').style.display = 'block';
        document.getElementById('fotp').value = ''; // clear OTP field
    } else {
        alert("Invalid OTP. Please try again.");
    }
}

function setNewPassword() {
    const newPassword = document.getElementById('fpass').value;
    
    if (!newPassword || newPassword.length < 6) {
        alert("Password must be at least 6 characters long.");
        return;
    }

    const userIndex = users.findIndex(u => u.phone === forgotPassPhone);
    
    if (userIndex !== -1) {
        users[userIndex].password = newPassword;
        saveAll();
        alert("Password updated successfully! Please log in with your new password.");
        
        // Reset the form fields for next use
        document.getElementById('fphone').value = '';
        document.getElementById('fpass').value = '';
        document.getElementById('fpass').style.display = 'none';
        document.getElementById('setPassBtn').style.display = 'none';
        document.getElementById('forgotOtpBox').style.display = 'block';
        document.getElementById('forgotOtpVerifyBox').style.display = 'none';
        
        openPage('login');
    } else {
        alert("Error: User data not found.");
    }
}
// ====== END FORGOT PASSWORD LOGIC ======

function guestLogin() {
    currentUser = {
        isGuest: true,
        name: 'Guest User',
        phone: 'N/A',
        wallet: Number(localStorage.getItem('wallet') || '5000') // Use global wallet for guest
    };
    alert("Logged in as Guest. Please note, listing and renting requires full login/KYC.");
    openPage('explore');
}
function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    localStorage.removeItem('wallet'); // Clear guest wallet if it exists
    stack = [];
    alert("Logged out successfully.");
    openPage('login');
}


// ====== WALLET LOGIC (UNCHANGED) ======
function recharge(){
    const amount = Number(document.getElementById('reAmt').value);
    const upi = document.getElementById('reUpi').value;
    if (amount > 0 && upi) {
        if(currentUser) {
            currentUser.wallet += amount;
            const txn = {id: Date.now(), type: 'credit', amount: amount, description: 'Wallet Recharge', mode: 'UPI', date: new Date().toLocaleString()};
            currentUser.txns.push(txn);
            transactions.push(txn);
        } else {
            wallet += amount;
        }
        saveAll();
        addNotif(`Wallet credited with ‚Çπ${amount}.`);
        alert(`Recharge successful: ‚Çπ${amount} added.`);
        openPage('walletPage');
    } else {
        alert("Please enter a valid amount and UPI ID.");
    }
}
function withdraw() {
    const amount = Number(document.getElementById('wiAmt').value);
    const acc = document.getElementById('wiAcc').value;
    const ifsc = document.getElementById('wiIfsc').value;
    const currentBalance = currentUser ? currentUser.wallet : wallet;

    if (amount > 0 && amount <= currentBalance && acc && ifsc) {
        if(currentUser) {
            currentUser.wallet -= amount;
            const txn = {id: Date.now(), type: 'debit', amount: amount, description: 'Withdrawal Request', mode: 'Bank', date: new Date().toLocaleString(), status: 'Pending'};
            currentUser.txns.push(txn);
            transactions.push(txn);
        } else {
            wallet -= amount;
        }
        saveAll();
        addNotif(`Withdrawal request for ‚Çπ${amount} submitted.`);
        alert(`Withdrawal request for ‚Çπ${amount} submitted. It will be processed shortly.`);
        openPage('walletPage');
    } else {
        alert("Invalid amount or missing bank details. Check balance.");
    }
}

// ====== ADDRESS LOGIC (UNCHANGED) ======
function openAddressPage(){ 
    if(!isLoggedIn()){
        alert("Please log in to manage your address.");
        return;
    }
    renderAddress();
    openPage('addressPage');
}
function renderAddress() {
    const display = document.getElementById('savedAddressDisplay');
    if (userAddress) {
        display.innerHTML = `
            <p><b>Address Line 1:</b> ${userAddress.line1}</p>
            <p><b>Address Line 2:</b> ${userAddress.line2 || 'N/A'}</p>
            <p><b>City:</b> ${userAddress.city}</p>
            <p><b>Pincode:</b> ${userAddress.pin}</p>
        `;
        document.getElementById('deleteAddressBtn').style.display = 'block';
    } else {
        display.innerHTML = '<p style="color:#ef4444;">No address saved.</p>';
        document.getElementById('deleteAddressBtn').style.display = 'none';
    }
}
function saveAddress() {
    const line1 = document.getElementById('addrLine1').value.trim();
    const line2 = document.getElementById('addrLine2').value.trim();
    const city = document.getElementById('addrCity').value.trim();
    const pin = document.getElementById('addrPin').value.trim();

    if (!line1 || !city || !pin || pin.length !== 6) {
        alert("Please enter a valid Address Line 1, City, and 6-digit Pincode.");
        return;
    }

    userAddress = { line1, line2, city, pin };
    localStorage.setItem('userAddress', JSON.stringify(userAddress)); 
    saveAll();
    alert("Address saved successfully!");
    renderAddress();
}
function deleteAddress() {
    if (confirm("Are you sure you want to delete the saved address?")) {
        userAddress = null;
        localStorage.removeItem('userAddress');
        saveAll();
        alert("Address deleted.");
        renderAddress();
    }
}

// ====== GEOLOCATION LOGIC (UNCHANGED) ======
function captureLocation() { 
    const statusText = document.getElementById('locationStatus');
    const statusBtn = document.getElementById('getLocationBtn');
    statusText.innerText = 'Capturing... Please allow location access.';
    statusBtn.disabled = true;

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                capturedLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                    time: new Date().toLocaleString()
                };
                statusText.innerText = `Location Captured! Lat: ${capturedLocation.lat.toFixed(4)}, Lon: ${capturedLocation.lon.toFixed(4)}`;
                statusText.style.color = '#22c55e';
                statusBtn.classList.remove('blue');
                statusBtn.classList.add('green');
                statusBtn.innerText = 'Location Captured';
                statusBtn.disabled = false;
            },
            (error) => {
                capturedLocation = null;
                let errorMessage;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Location access denied by the user.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Location information is unavailable.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "The request to get user location timed out.";
                        break;
                    default:
                        errorMessage = "An unknown error occurred.";
                        break;
                }
                statusText.innerText = `Error capturing location: ${errorMessage}`;
                statusText.style.color = '#ef4444';
                statusBtn.disabled = false;
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    } else {
        capturedLocation = null;
        statusText.innerText = "Geolocation is not supported by this browser.";
        statusText.style.color = '#ef4444';
        statusBtn.disabled = false;
    }
}

// ====== BIKE LISTING LOGIC (V2.6 - UPDATED FOR MANDATORY REG NO. & FUEL TYPE) ======
function submitBike(){ 
    if(!isLoggedIn()){ alert("Please log in to list a bike."); return; }
    if(kycStatus !== 'approved'){ alert(`You must have an approved KYC to list a bike. Current status: ${kycStatus.toUpperCase()}`); return; }

    const name = ownerName.value;
    const phone = ownerPhone.value;
    const bike = bikeName.value;
    const fuelType = bikeFuelType.value; // V2.6: New Field
    
    const regNo = bikeRegNo.value.toUpperCase().trim();
    
    const state = bikeState.value; 
    const city = bikeCity.value.trim(); 
    const rent = rentDay.value;
    const expiry = bikeExpiry.value;
    
    const rcFile = imgRC.files[0]; 
    const files = [imgFront.files[0], imgBack.files[0], imgLeft.files[0], imgRight.files[0]];
    
    let missingFields = [];
    if (!name) missingFields.push("Owner Name");
    if (!phone) missingFields.push("Owner Phone");
    if (!bike) missingFields.push("Bike Name");
    if (!fuelType) missingFields.push("Fuel Type"); // V2.6: Fuel Type Check
    
    // Bike Registration Number Mandatory Check
    if (!regNo) {
        missingFields.push("Bike Registration Number");
    } else if (regNo.length < 5) { 
        alert("Bike Registration Number seems too short. Please enter a valid number (e.g., UP65AA1234).");
        return;
    }
    
    if (!state) missingFields.push("State"); 
    if (!city) missingFields.push("City"); 
    if (!rent) missingFields.push("Rent per Day");
    if (!expiry) missingFields.push("Bike Expiry");
    if (!rcFile) missingFields.push("RC Photo"); 
    if (files.some(f => !f) || files.length !== 4) missingFields.push("Four Bike Photos (Front, Back, Left, Right)");
    if (!capturedLocation) missingFields.push("Current Location (GPS)"); 

    if (missingFields.length > 0) {
        alert("Please fill all mandatory fields to proceed:\n\n- " + missingFields.join('\n- ')); return;
    }
    
    const allFiles = [rcFile, ...files];

    try {
        Promise.all(allFiles.map(getBase64)).then(images => {
            const newBike = {
                id: Date.now(), 
                owner: currentUser.phone, 
                ownerName: name, 
                ownerPhone: phone, 
                bikeName: bike, 
                fuelType: fuelType, // V2.6: Saved Fuel Type
                bikeRegNo: regNo, 
                state: state, 
                city: city, 
                coords: capturedLocation, 
                rent: Number(rent), 
                expiry: expiry,
                images: {
                    rc: images[0], 
                    front: images[1], 
                    back: images[2], 
                    left: images[3], 
                    right: images[4]
                }, 
                status: 'pending' 
            };
            bikes.push(newBike);
            // Assuming currentUser has listedBikes array
            if(currentUser.listedBikes) currentUser.listedBikes.push(newBike.id);
            else currentUser.listedBikes = [newBike.id];
            
            saveAll();
            addNotif(`Bike '${bike}' submitted for approval.`);
            alert("Bike submitted for admin approval.");
            openPage('home');
        }).catch(e => {
            alert("Error reading files/saving data: " + e.message + ". Try using smaller image files.");
        });
    } catch(e) {
        alert("Error during file processing: " + e.message);
    }
}

// ====== BIKE RENDER/DETAIL LOGIC (V2.10 - View Details Button Fixed) ======
function renderBikes() { 
    const list = document.getElementById('bikeList');
    list.innerHTML = '';
    const approvedBikes = bikes.filter(b => b.status === 'approved');

    if (approvedBikes.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#64748b;">No approved bikes found.</p>';
        return;
    }

    approvedBikes.forEach((bike, index) => {
        const bikeIndex = bikes.findIndex(b => b.id === bike.id); 
        list.innerHTML += `
            <div class="card">
                <img src="${bike.images.front}" alt="${bike.bikeName}" style="width:100%; height:180px; object-fit:cover; border-radius:8px;">
                <h4 style="margin:8px 0 0;">${bike.bikeName}</h4>
                <p style="margin:2px 0; font-size:14px; color:#3b82f6;">Reg No: ${bike.bikeRegNo}</p>
                <p style="margin:2px 0; font-size:14px;">‚õΩ Fuel: <b>${bike.fuelType || 'N/A'}</b></p>
                <p style="margin:2px 0; font-size:14px;">üìç ${bike.city}, ${bike.state}</p> 
                <p style="margin:2px 0;">Rent: <b>‚Çπ${bike.rent}</b>/day</p>
                <small>Owner: ${bike.ownerName}</small>
                
                <button class="blue" style="margin-top:10px; padding:10px;" onclick="openDetail(${bikeIndex})">
                    View Details
                </button>
            </div>
        `;
    });
}
function openDetail(index) { 
    currentBikeIndex = index;
    const bike = bikes[index];
    
    pf.src = bike.images.front;
    pb.src = bike.images.back;
    pl.src = bike.images.left;
    pr.src = bike.images.right;

    dBike.innerText = bike.bikeName;
    dRegNo.innerText = bike.bikeRegNo; 
    
    document.getElementById('dFuelType').innerText = bike.fuelType || 'N/A'; // V2.6: Fuel Type
    
    dState.innerText = bike.state; 
    dCity.innerText = bike.city; 
    dRate.innerText = bike.rent.toFixed(2);
    days = 1; 
    document.getElementById('days').innerText = days;
    document.getElementById('totalAmt').innerText = (Number(bike.rent) * days).toFixed(2); // Fix for total calculation

    openPage('detail');
}
function changeDays(change) {
    days += change;
    if (days < 1) days = 1;
    document.getElementById('days').innerText = days;
    const rate = Number(dRate.innerText);
    document.getElementById('totalAmt').innerText = (rate * days).toFixed(2);
}

// ====== RENTAL/PAYMENT LOGIC (V2.4 - Rent Now Fix) ======
function checkAuthAndRent(){ 
    if (!isLoggedIn()) {
        alert("Please Login or Sign Up to rent a bike.");
        stack = [];
        openPage('login');
        return; 
    }
    
    if (kycStatus === 'approved') {
        const bike = bikes[currentBikeIndex];
        if (!bike) {
             alert("Error: Bike details not found.");
             openPage('explore');
             return;
        }

        // Set verification details
        document.getElementById('vBikeName').innerText = bike.bikeName;
        document.getElementById('vDays').innerText = days;
        document.getElementById('vAmount').innerText = (bike.rent * days).toFixed(2);
        
        // Pre-fill fields with dummy/current data if available
        document.getElementById('vname').value = currentUser.name || 'Test User';
        document.getElementById('vphone').value = currentUser.phone || '9998887770';

        openPage('verify'); 
    } else if (kycStatus === 'pending') {
        alert("Your KYC is under review. Please wait for approval before renting.");
    } else if (kycStatus === 'rejected') {
        if(confirm(`Your KYC was rejected (${kycReason}). Do you want to submit updated documents now?`)){
             openPage('completeKYC');
        }
    } else { // kycStatus === 'none'
        if(confirm("KYC is required for rental. Do you want to submit your documents now?")){
            openPage('completeKYC');
        }
    }
}

function verifyRentalData() { 
    const vname = document.getElementById('vname').value;
    const vphone = document.getElementById('vphone').value;
    const vaad = document.getElementById('vaad').value;
    const vpan = document.getElementById('vpan').value;
    const vdl = document.getElementById('vdl').value;

    if (!vname || vphone.length !== 10 || vaad.length !== 12 || !vpan || !vdl) {
        alert("Please fill all mandatory verification details correctly.");
        return;
    }

    // Simulate verification success
    alert("Verification successful. Proceeding to payment.");
    goPayment();
}

function goPayment(){ 
    const total = Number(document.getElementById('vAmount').innerText); 
    payAmount.innerText = total.toFixed(2);
    walletBal.innerText = (currentUser ? currentUser.wallet : wallet).toFixed(2);
    openPage('payment');
}
function showPay(){ 
    const mode = payMode.value;
    walletBox.style.display = 'none';
    upiBox.style.display = 'none';
    cardBox.style.display = 'none';

    if (mode === 'wallet') walletBox.style.display = 'block';
    if (mode === 'upi') upiBox.style.display = 'block';
    if (mode === 'card') cardBox.style.display = 'block';
}
function pay(){ 
    const amount = Number(payAmount.innerText);
    const mode = payMode.value;

    if (!mode) {
        alert("Please select a payment mode.");
        return;
    }

    if (mode === 'wallet') {
        const currentBalance = currentUser ? currentUser.wallet : wallet;
        if (currentBalance >= amount) {
            processRental(amount, mode);
        } else {
            alert(`Insufficient Wallet Balance. Current: ‚Çπ${currentBalance.toFixed(2)}. Needed: ‚Çπ${amount.toFixed(2)}.`);
        }
    } else {
        // Assume external payment success for UPI/Card
        if ((mode === 'upi' && !document.getElementById('upiId').value) ||
            (mode === 'card' && (!document.getElementById('cardNo').value || !document.getElementById('cardExp').value || !document.getElementById('cardCvv').value))) {
            alert("Please fill in payment details.");
            return;
        }
        processRental(amount, mode);
    }
}
function processRental(amount, mode){ 
    if (!currentUser) return;

    if (mode === 'wallet') {
        currentUser.wallet -= amount;
        wallet = currentUser.wallet;
    }
    
    const bike = bikes[currentBikeIndex];
    const rentalId = Date.now();
    
    // 1. Record Transaction
    const txn = {id: rentalId, type: 'debit', amount: amount, description: `Bike Rental: ${bike.bikeName}`, mode: mode, date: new Date().toLocaleString()};
    currentUser.txns.push(txn);
    transactions.push(txn);
    
    // 2. Record Rental History
    const rental = {id: rentalId, bikeName: bike.bikeName, amount: amount, days: days, date: new Date().toLocaleString()};
    currentUser.rentals.push(rental);
    rentals.push(rental);

    // 3. Create Invoice
    const invoice = {id: rentalId, description: `Rental of ${bike.bikeName} for ${days} days`, amount: amount, date: new Date().toLocaleString()};
    invoices.push(invoice);
    
    saveAll();
    addNotif(`You have successfully rented ${bike.bikeName} for ‚Çπ${amount}.`);
    alert(`Rental Successful! Total amount ‚Çπ${amount.toFixed(2)} charged via ${mode}.`);
    
    openPage('home');
}

// ====== KYC/ADMIN LOGIC (V2.15 UPDATES) ======
function openCompleteKYC() {
    if (kycStatus === 'pending') {
        alert("Your KYC is already submitted and pending review.");
    } else {
        openPage('completeKYC');
    }
}
function submitKYC() {
    const aadFront = document.getElementById('aadFront').files[0];
    const aadBack = document.getElementById('aadBack').files[0];
    const panFront = document.getElementById('panFront').files[0];
    const dlFront = document.getElementById('dlFront').files[0];

    if (!aadFront || !aadBack || !panFront || !dlFront) {
        alert("Please upload all four required KYC documents.");
        return;
    }

    Promise.all([aadFront, aadBack, panFront, dlFront].map(getBase64)).then(images => {
        kycData = {
            aadhaarFront: images[0],
            aadhaarBack: images[1],
            pan: images[2],
            dl: images[3]
        };
        kycStatus = 'pending';
        kycReason = '';
        kycSubmittedAt = Date.now();
        localStorage.setItem(`kycStatus_${currentUser.phone}`, 'pending');
        saveAll();
        addNotif("KYC documents submitted for admin review.");
        alert("KYC submitted successfully and is pending admin approval.");
        openPage('profile');
    }).catch(e => {
        alert("Error reading files: " + e.message);
    });
}


// V2.15: RENDER ADMIN KYC - Includes Ban/Unban buttons
function renderAdminKYC(){
    const adminKycState = document.getElementById('adminKycState');
    const rejectReasonInput = document.getElementById('rejectReason');
    const kycAdminButtons = document.getElementById('kycAdminButtons');
    
    // V2.15: Simple demo: We will show the details of the LAST registered user for demo purposes.
    // In a real app, this would be a list of pending KYCs.
    const userToReview = users.length > 0 ? users[users.length - 1] : null; 

    if (!userToReview) {
         adminKycState.innerText = 'No Users Registered';
         adminKycState.style.color = '#64748b';
         rejectReasonInput.value = '';
         kycAdminButtons.innerHTML = '';
         return;
    }

    const isBanned = userToReview.isBanned;
    
    // For Demo: Use kycStatus from global store or mock it for the displayed user
    const currentKycStatus = localStorage.getItem(`kycStatus_${userToReview.phone}`) || 'none'; 

    // --- Display Status ---
    adminKycState.innerHTML = `User: <b>${userToReview.name}</b> (${userToReview.phone})<br>`;
    adminKycState.innerHTML += `KYC: <b style="color:${currentKycStatus === 'approved' ? '#22c55e' : (currentKycStatus === 'pending' ? '#3b82f6' : '#ef4444')};">${currentKycStatus.toUpperCase()}</b><br>`;
    adminKycState.innerHTML += `Account: <b style="color:${isBanned ? '#ef4444' : '#22c55e'};">${isBanned ? 'BANNED' : 'ACTIVE'}</b>`;
    
    rejectReasonInput.value = currentKycStatus === 'rejected' ? localStorage.getItem("kycReason") || '' : '';
    
    // --- Render Buttons (Updated) ---
    kycAdminButtons.innerHTML = '';
    
    if (currentKycStatus === 'pending') {
        // NOTE: approveKYC and rejectKYC need the phone number in a real implementation
        // For simplicity, they will currently act on the global kycStatus state for demo.
        kycAdminButtons.innerHTML += `<button class="green" onclick="approveKYC('${userToReview.phone}')">‚úÖ Approve KYC</button>`;
        kycAdminButtons.innerHTML += `<button class="gray" onclick="rejectKYC('${userToReview.phone}')">‚ùå Reject KYC</button>`;
    } else if (currentKycStatus === 'rejected') {
        kycAdminButtons.innerHTML += `<p style="color:#ef4444;">KYC Rejected.</p>`;
    } else if (currentKycStatus === 'approved') {
         kycAdminButtons.innerHTML += `<p style="color:#22c55e;">KYC Approved.</p>`;
    }

    // V2.15: Ban/Unban Buttons (Always available)
    if (!isBanned) {
        kycAdminButtons.innerHTML += `<button class="red" onclick="banUser('${userToReview.phone}')" style="margin-top: 20px;">üö´ BAN Account</button>`;
    } else {
        kycAdminButtons.innerHTML += `<button class="green" onclick="unbanUser('${userToReview.phone}')" style="margin-top: 20px;">üîì UNBAN Account</button>`;
    }
}


// V2.15: Approve/Reject updated for potential user targeting (still simplified demo)
function approveKYC(phone = currentUser.phone) {
    const user = users.find(u => u.phone === phone);
    if (user) {
        // In a real app, update the specific user's KYC status
        localStorage.setItem(`kycStatus_${phone}`, 'approved');
        kycStatus = 'approved'; // Update global state for demo user
        kycReason = 'Approved by Admin';
        saveAll();
        addNotif("Your KYC has been approved!");
        alert("KYC Approved.");
        renderAdminKYC();
    } else {
        alert("No user found or no pending KYC to approve.");
    }
}
function rejectKYC(phone = currentUser.phone) {
    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
        alert("Please enter a reason for rejection.");
        return;
    }
    
    const user = users.find(u => u.phone === phone);
    if (user) {
        localStorage.setItem(`kycStatus_${phone}`, 'rejected');
        kycStatus = 'rejected'; // Update global state for demo user
        kycReason = reason;
        saveAll();
        addNotif(`Your KYC was rejected: ${reason}`);
        alert("KYC Rejected.");
        renderAdminKYC();
    } else {
         alert("No user found or no pending KYC to reject.");
    }
}


function openAdminLogin(targetPage) { 
    localStorage.setItem('adminTarget', targetPage);
    openPage('adminLogin');
}
function adminLogin() {
    const phone = adminPhone.value;
    const pass = adminPass.value;
    const target = localStorage.getItem('adminTarget');

    // V2.12: Check against FIXED Admin Phone AND FIXED Admin Password
    if (phone === ADMIN_PHONE && pass === ADMIN_PASS) {
        alert("Admin Login Successful!");
        adminPhone.value = '';
        adminPass.value = '';
        if(target) openPage(target);
    } else {
        alert("Invalid Admin Credentials.");
    }
}


// V2.15: RENDER ADMIN BIKES - Includes Delete button for every bike
function renderAdminBikes() {
    const adminList = document.getElementById('adminList');
    adminList.innerHTML = '';
    
    // V2.15: Show ALL bikes (Approved, Pending, Rejected) for full admin control
    const allBikes = bikes.slice().reverse(); // Show newest first

    if (allBikes.length === 0) { 
        adminList.innerHTML = '<p style="text-align:center;color:#64748b;">No bikes listed in the system.</p>';
        return;
    }

    allBikes.forEach(bike => {
        let statusColor, statusText;
        if (bike.status === 'approved') { statusColor = '#22c55e'; statusText = 'Approved'; }
        else if (bike.status === 'pending') { statusColor = '#3b82f6'; statusText = 'Pending Review'; }
        else { statusColor = '#ef4444'; statusText = 'Rejected'; }

        adminList.innerHTML += `
            <div class="card" id="adminBike-${bike.id}" style="border-left: 5px solid ${statusColor};">
                <h4>${bike.bikeName} (${bike.bikeRegNo})</h4>
                <p style="margin:2px 0;">Owner: ${bike.ownerName} (${bike.ownerPhone})</p>
                <p style="margin:2px 0; color:${statusColor};">Listing Status: <b>${statusText}</b></p>
                <p style="margin:2px 0; color:#ef4444; font-size:12px;">Confidential GPS: Lat: ${bike.coords.lat.toFixed(4)}, Lon: ${bike.coords.lon.toFixed(4)}</p>

                <h5>Documents:</h5>
                <div class="admin-img-row">
                    <img src="${bike.images.rc}" alt="RC Photo" title="RC Photo">
                    <img src="${bike.images.front}" alt="Front Photo">
                </div>
                
                ${bike.status === 'pending' ? `<button class="green" onclick="approveBike(${bike.id})">‚úÖ Approve</button>` : ''}
                ${bike.status !== 'rejected' ? `<button class="red" onclick="rejectBike(${bike.id})">‚ùå Reject</button>` : ''}
                
                <button class="gray" onclick="deleteAnyBike(${bike.id}, '${bike.bikeName}')" style="background:#0f172a;">
                    üóë Delete Permanently
                </button>
            </div>
        `;
    });
}


function approveBike(id) {
    const bike = bikes.find(b => b.id === id);
    if (bike) {
        bike.status = 'approved';
        saveAll();
        addNotif(`Admin approved bike '${bike.bikeName}'. It is now live.`);
        alert(`Bike ${bike.bikeName} approved!`);
        renderAdminBikes();
        renderListedBikes(); // Update owner's listed bike status
    }
}
function rejectBike(id) {
    const bike = bikes.find(b => b.id === id);
    if (bike) {
        if (confirm(`Are you sure you want to reject the bike ${bike.bikeName}?`)) {
            bike.status = 'rejected';
            saveAll();
            addNotif(`Admin rejected bike '${bike.bikeName}'.`);
            alert(`Bike ${bike.bikeName} rejected.`);
            renderAdminBikes();
            renderListedBikes(); // Update owner's listed bike status
        }
    }
}

// V2.15: New Admin Moderation Functions
function banUser(phone) {
    if (!confirm(`Are you sure you want to BAN the user with phone number ${phone}? They will not be able to log in.`)) {
        return;
    }
    
    const userIndex = users.findIndex(u => u.phone === phone);
    if (userIndex !== -1) {
        users[userIndex].isBanned = true;
        saveAll();
        alert(`User ${phone} has been successfully BANNED.`);
    } else {
        alert("Error: User not found.");
    }
    renderAdminKYC();
}

function unbanUser(phone) {
    if (!confirm(`Are you sure you want to UNBAN the user with phone number ${phone}? They will regain login access.`)) {
        return;
    }
    
    const userIndex = users.findIndex(u => u.phone === phone);
    if (userIndex !== -1) {
        users[userIndex].isBanned = false;
        saveAll();
        alert(`User ${phone} has been successfully UNBANNED.`);
    } else {
        alert("Error: User not found.");
    }
    renderAdminKYC();
}

function deleteAnyBike(id, bikeName) {
    if (!confirm(`ADMIN WARNING: Are you sure you want to PERMANENTLY DELETE the bike listing "${bikeName}" (ID: ${id})?`)) {
        return;
    }
    
    // 1. Remove from the global bikes array
    bikes = bikes.filter(b => b.id !== id);

    // 2. Remove from the respective owner's listedBikes array
    const owner = users.find(u => u.listedBikes && u.listedBikes.includes(id));
    if (owner) {
        owner.listedBikes = owner.listedBikes.filter(bikeId => bikeId !== id);
    }

    saveAll();
    addNotif(`Admin deleted bike listing (ID: ${id}).`);
    alert(`Bike listing "${bikeName}" deleted successfully by Admin.`);
    
    // Re-render the admin bike list and the explore page
    renderAdminBikes(); 
    renderBikes(); 
}

// ====== SUPPORT REQUEST LOGIC (V2.9) ======

function submitSupportRequest() {
    const name = document.getElementById('supportName').value.trim();
    const email = document.getElementById('supportEmail').value.trim();
    const phone = document.getElementById('supportPhone').value.trim();
    const message = document.getElementById('supportMessage').value.trim();

    if (!email || !phone || !message || phone.length !== 10) {
        alert("Please enter a valid Email, 10-digit Mobile Number, and your detailed Message.");
        return;
    }
    
    const newRequest = {
        id: supportRequests.length + 1,
        name: name || 'N/A',
        email: email,
        phone: phone,
        message: message,
        date: new Date().toLocaleString(),
        status: 'new' 
    };

    supportRequests.push(newRequest);
    saveAll();
    
    // Reset form
    document.getElementById('supportName').value = currentUser ? currentUser.name || '' : '';
    document.getElementById('supportEmail').value = currentUser ? currentUser.email || '' : '';
    document.getElementById('supportPhone').value = currentUser ? currentUser.phone || '' : '';
    document.getElementById('supportMessage').value = '';

    alert("Your support request has been submitted successfully! The admin will review it shortly.");
    addNotif("Your support request has been registered.");
    openPage('profile');
}

// ====== ADMIN SUPPORT LOGIC (V2.9) ======

function renderAdminSupport() {
    const list = document.getElementById('supportList');
    list.innerHTML = '';
    
    if (supportRequests.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#64748b;">No support requests found.</p>';
        return;
    }

    supportRequests.reverse().forEach(req => {
        let statusColor = req.status === 'resolved' ? '#22c55e' : '#ef4444';
        
        list.innerHTML += `
            <div class="card" style="border-left: 5px solid ${statusColor}; padding:10px;">
                <p style="margin:0; font-weight:bold;">Subject: ${req.message.substring(0, 50)}...</p>
                <small>Submitted By: ${req.name} (${req.phone})</small><br>
                <small>Email: ${req.email}</small>
                <p style="margin:5px 0 0; font-size:14px;">Status: 
                    <b style="color:${statusColor};">${req.status.toUpperCase()}</b>
                </p>
                <button class="blue" style="margin-top:5px; padding:8px; width:48%; display:inline-block;"
                        onclick="alert('Full Message: ${req.message}')">View Details</button>
                <button class="green" style="margin-top:5px; padding:8px; width:48%; display:inline-block;"
                        onclick="resolveSupportRequest(${req.id})">Mark Resolved</button>
            </div>
        `;
    });
}

function resolveSupportRequest(id) {
    const req = supportRequests.find(r => r.id === id);
    if (req) {
        req.status = 'resolved';
        saveAll();
        alert(`Request ID ${id} resolved and status updated.`);
        renderAdminSupport();
    }
}

// ====== RENDER FUNCTIONS FOR HISTORY/LISTS (V2.10 - Delete Listing Added) ======

function openWallet() {
    if (!isLoggedIn()) { alert("Please log in."); return; }
    openPage('walletPage');
}

function openTxns() {
    if (!isLoggedIn()) { alert("Please log in."); return; }
    openPage('txnPage');
}

function openInvoices() {
    if (!isLoggedIn()) { alert("Please log in."); return; }
    openPage('invoicePage');
}

function openNotifs() {
    if (!isLoggedIn()) { alert("Please log in."); return; }
    openPage('notifPage');
}

function openRentals() {
    if (!isLoggedIn()) { alert("Please log in."); return; }
    openPage('rentalHistory');
}

function openListed() {
    if (!isLoggedIn()) { alert("Please log in."); return; }
    openPage('listedBikes');
}

function renderTxns() {
    const list = document.getElementById('txnList');
    list.innerHTML = '';
    const userTxns = currentUser && !currentUser.isGuest ? currentUser.txns : transactions;

    if (userTxns.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#64748b;">No transactions yet.</p>';
        return;
    }

    userTxns.reverse().forEach(txn => {
        const color = txn.type === 'credit' ? '#22c55e' : '#ef4444';
        const sign = txn.type === 'credit' ? '+' : '-';
        list.innerHTML += `
            <div class="card" style="border-left: 5px solid ${color}; padding:10px;">
                <p style="margin:0; font-weight:bold;">${txn.description}</p>
                <p style="margin:2px 0; color:${color};">Amount: ${sign} ‚Çπ${txn.amount.toFixed(2)} (${txn.mode})</p>
                <small>${txn.date}</small>
            </div>
        `;
    });
}

function renderInvoices() {
    const list = document.getElementById('invList');
    list.innerHTML = '';
    
    if (invoices.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#64748b;">No invoices found.</p>';
        return;
    }

    invoices.reverse().forEach(inv => {
        list.innerHTML += `
            <div class="card">
                <p style="margin:0; font-weight:bold;">${inv.description}</p>
                <p style="margin:2px 0;">Amount: ‚Çπ${inv.amount.toFixed(2)}</p>
                <small>Invoice Date: ${inv.date}</small>
                <button class="blue" style="margin-top:5px; padding:8px;" 
                        onclick="alert('Downloading Invoice ID: ${inv.id}...')">Download</button>
            </div>
        `;
    });
}

function downloadInvoice() {
    if (invoices.length === 0) {
        alert("No invoices to download.");
        return;
    }
    const lastInvoice = invoices[invoices.length - 1];
    const invoiceDetails = 
        `--- RENTELBIKE INVOICE ---\n` +
        `ID: ${lastInvoice.id}\n` +
        `Date: ${lastInvoice.date}\n` +
        `Description: ${lastInvoice.description}\n` +
        `Total Amount: ‚Çπ${lastInvoice.amount.toFixed(2)}\n` +
        `User: ${currentUser ? currentUser.name : 'N/A'}\n` +
        `--- Thank You ---`;
    
    // Simulate printing/downloading
    alert("Simulated Print/Download:\n\n" + invoiceDetails);
}

function renderRentals() {
    const list = document.getElementById('rentalList');
    list.innerHTML = '';
    const userRentals = currentUser && !currentUser.isGuest ? currentUser.rentals : rentals;

    if (userRentals.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#64748b;">No rental history found.</p>';
        return;
    }

    userRentals.reverse().forEach(rental => {
        list.innerHTML += `
            <div class="card" style="border-left: 5px solid #3b82f6; padding:10px;">
                <p style="margin:0; font-weight:bold;">üèç ${rental.bikeName}</p>
                <p style="margin:2px 0;">Days: ${rental.days} | Total: ‚Çπ${rental.amount.toFixed(2)}</p>
                <small>Rented On: ${rental.date}</small>
            </div>
        `;
    });
}

function renderListedBikes() {
    const list = document.getElementById('listedList');
    list.innerHTML = '';
    
    // ‡§ï‡•á‡§µ‡§≤ ‡§µ‡§π‡•Ä ‡§¨‡§æ‡§á‡§ï ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§Æ‡§æ‡§≤‡§ø‡§ï ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® logged-in user ‡§π‡•à
    const userBikes = bikes.filter(b => b.owner === (currentUser ? currentUser.phone : ''));

    if (userBikes.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#64748b;">You have not listed any bikes.</p>';
        return;
    }

    userBikes.reverse().forEach(bike => {
        let statusColor, statusText;
        if (bike.status === 'approved') { statusColor = '#22c55e'; statusText = 'Approved'; }
        else if (bike.status === 'pending') { statusColor = '#3b82f6'; statusText = 'Pending Review'; }
        else { statusColor = '#ef4444'; statusText = 'Rejected'; }

        list.innerHTML += `
            <div class="card" style="border-left: 5px solid ${statusColor}; padding:10px;">
                <p style="margin:0; font-weight:bold;">${bike.bikeName} (${bike.bikeRegNo})</p>
                <p style="margin:2px 0;">Fuel Type: ${bike.fuelType || 'N/A'}</p> 
                <p style="margin:2px 0;">Rent: ‚Çπ${bike.rent}/day</p>
                <p style="margin:2px 0; color:${statusColor};">Status: <b>${statusText}</b></p>
                <small>Listed On: ${new Date(bike.id).toLocaleDateString()}</small>
                
                <button class="red" style="margin-top:10px; padding:8px;" onclick="deleteBike(${bike.id})">
                    Delete Listing
                </button>
            </div>
        `;
    });
}

// V2.10: Function to Delete Listing
function deleteBike(id) {
    if (!confirm("Are you sure you want to permanently delete this bike listing? This action cannot be undone.")) {
        return;
    }

    // 1. Remove from the global bikes array
    const initialLength = bikes.length;
    bikes = bikes.filter(b => b.id !== id);

    if (bikes.length === initialLength) {
        alert("Error: Bike not found in system.");
        return;
    }

    // 2. Remove from the current user's listedBikes array (if logged in)
    if (currentUser && currentUser.listedBikes) {
        currentUser.listedBikes = currentUser.listedBikes.filter(bikeId => bikeId !== id);
    }

    saveAll();
    addNotif(`Bike listing (ID: ${id}) has been permanently deleted.`);
    alert("Listing deleted successfully!");
    renderListedBikes(); // Re-render the list immediately
}


function renderNotifs() {
    const list = document.getElementById('notifList');
    list.innerHTML = '';

    if (notifs.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#64748b;">No notifications.</p>';
        return;
    }

    notifs.reverse().forEach(notif => {
        list.innerHTML += `
            <div class="card" style="padding:10px;">
                <p style="margin:0;">üîî ${notif.msg}</p>
                <small>${notif.date}</small>
            </div>
        `;
    });
}

// ====== NEW IMAGE ZOOM FUNCTIONALITY V2.7 ======
function setupZoomableImages() {
    // Zoomable images are those inside cards, sliders, or admin rows
    const zoomableImages = document.querySelectorAll('.card img, .img-slider img, .admin-img-row img');
    
    zoomableImages.forEach(img => {
        // Prevent setting the click handler multiple times
        if (!img.hasAttribute('data-zoom-setup')) {
            img.setAttribute('data-zoom-setup', 'true');
            img.onclick = function(event) {
                event.stopPropagation(); // Stop event bubbling up to the card/page
                openZoom(this.src);
            };
        }
    });
}

function openZoom(src) {
    const overlay = document.getElementById('image-zoom-overlay');
    const zoomedImg = document.getElementById('zoomed-img');
    
    zoomedImg.src = src;
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent scrolling background
    
    // Allow drag to pan the image (optional, basic logic)
    let isDragging = false;
    let startX, startY, imgX = 0, imgY = 0;

    zoomedImg.style.transform = 'scale(1)'; // Reset zoom/pan
    
    zoomedImg.onmousedown = (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        zoomedImg.style.cursor = 'grabbing';
    };

    overlay.onmousemove = (e) => {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        
        imgX += dx;
        imgY += dy;
        
        zoomedImg.style.transform = `translate(${imgX}px, ${imgY}px)`;
        startX = e.clientX;
        startY = e.clientY;
    };

    overlay.onmouseup = () => {
        isDragging = false;
        zoomedImg.style.cursor = 'grab';
    };

    // Prevent default drag action
    zoomedImg.ondragstart = () => false;
}

function closeZoom() {
    const overlay = document.getElementById('image-zoom-overlay');
    overlay.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
    
    // Clean up drag handlers
    overlay.onmousemove = null;
    overlay.onmouseup = null;
    document.getElementById('zoomed-img').onmousedown = null;
}
// Initial Setup
document.addEventListener('DOMContentLoaded', () => {
    // Ensure initial user data is loaded correctly
    if (currentUser) {
        // Load user-specific KYC status if user is logged in (not guest)
        if(!currentUser.isGuest) {
            const userKycStatus = localStorage.getItem(`kycStatus_${currentUser.phone}`);
            if(userKycStatus) kycStatus = userKycStatus;
            
            // Ensure listedBikes and rentals exist on user object if missing
            if(!currentUser.listedBikes) currentUser.listedBikes = [];
            if(!currentUser.rentals) currentUser.rentals = [];
            if(!currentUser.txns) currentUser.txns = [];
            if(currentUser.isBanned === undefined) currentUser.isBanned = false; // V2.15: ensure ban status exists
        }

        // Load address based on user (or global if guest logic)
        const savedAddr = JSON.parse(localStorage.getItem(`address_${currentUser.phone}`) || localStorage.getItem('userAddress') || 'null');
        userAddress = savedAddr;
        
        openPage('home'); 
    } else {
        openPage('login');
    }
});
</script>


  
</body>
</html>
    
  
  

