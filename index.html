<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RentelBike</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* --- General Styles --- */
body{margin:0;font-family:Arial, sans-serif;background:#f2f2f2}
header{background:#0f172a;color:#fff;padding:14px;text-align:center;font-weight:bold; position: fixed; top: 0; width: 100%; z-index: 10;}

.page{
  display:none;
  padding:15px;
  padding-bottom:90px;
  min-height: calc(100vh - 40px); /* Ensures page takes full viewport height */
  box-sizing: border-box; 
  position: absolute; /* Ensures pages stack on top of each other, not below */
  top: 40px; /* Space for Header */
  left: 0;
  width: 100%;
  background: #f2f2f2; /* Ensures background is covered */
}
.page.active{display:block}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
input,select,textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;margin-top:8px;box-sizing:border-box}
button{width:100%;padding:12px;border:none;border-radius:6px;margin-top:10px;font-weight:bold}
.green{background:#22c55e;color:#fff}
.gray{background:#64748b;color:#fff}
.blue{background:#3b82f6;color:#fff} 

/* --- Navigation Styles --- */
nav{
  position:fixed;
  bottom:0;
  width:100%;
  display:none; /* Hidden by default */
  background:#fff;
  border-top:1px solid #ccc;
  z-index: 10;
}
body.logged-in nav { 
  display: flex; /* Shown when logged in */
}
nav button{flex:1;background:#fff;border:none;padding:10px;font-size:14px}
.profile-item{padding:14px;border-bottom:1px solid #eee;cursor:pointer}
small{font-size:11px;color:#6b7280}

/* --- Image and Slider Styles --- */
.img-slider{display:flex;gap:8px;overflow-x:auto;margin-bottom:10px}
.img-slider img{
  width:90%; 
  min-width: 90%; 
  height: 150px;
  object-fit:cover;
  border-radius:10px
}

/* Admin KYC/Bike Image Row */
.admin-img-row img {
    width: 23%; /* To fit 4 images in a row */
    min-width: 23%; 
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
}

/* --- Login Page Background (Updated) --- */
#login {
    /* REMINDER: Please replace the placeholder URL with your image URL or Base64 data */
    background-image: url('https://via.placeholder.com/1080x1920?text=RentelBike+Login+BG'); 
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    display: flex; 
    justify-content: center;
    align-items: center;
    height: 100vh; 
    padding-top: 0;
    top: 0; /* Important for full screen login */
    padding-bottom: 0;
}

#login .card {
    background: rgba(255, 255, 255, 0.9); /* Semi-transparent card */
    padding: 20px;
    width: 90%;
    max-width: 350px;
}
</style>
</head>

<body>
<header>RentelBike</header>

<div id="login" class="page active">
  <div class="card">
    <h3>Login</h3>
    <input id="lphone" placeholder="Mobile" maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <input id="lpass" placeholder="Password / OTP" type="password">
    <button class="green" onclick="login()">Login</button>
    <button class="gray" onclick="openPage('signupForm')">New User? Sign Up</button> 
    <button class="blue" onclick="guestLogin()">Skip for now</button>
  </div>
</div>

<div id="signupForm" class="page">
    <div class="card">
        <h3>Create Account</h3>
        <input id="sname" placeholder="Full Name *">
        <input id="semail" placeholder="Email (Optional)">
        <label>Date of Birth (Optional)</label>
        <input type="date" id="sdob">
        <input id="sreferral" placeholder="Referral Code (Optional)">
        <input id="sphone" placeholder="Mobile *" maxlength="10"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <input id="spass" placeholder="Set Password *" type="password">
        <button class="green" onclick="signup()">Sign Up & Complete</button>
        <button class="gray" onclick="openPage('login')">‚Üê Back to Login</button> 
    </div>
</div>

<div id="home" class="page">
  <div class="card">
    <h3>Dashboard</h3>
    <button class="green" onclick="openPage('explore')">Explore Bikes</button>
    <button class="green" onclick="checkAuth('listbike')">List a Bike</button>
    <button class="green" onclick="openAdminLogin('admin')">Admin Bike Panel</button>
    <button class="green" onclick="openAdminLogin('adminKYC')">Admin KYC Panel</button>
  </div>
</div>

<div id="listbike" class="page">
  <div class="card">
    <h3>List Bike</h3>
    <input id="ownerName" placeholder="Owner Name *">
    <input id="ownerPhone" placeholder="Owner Phone *" maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <input id="bikeName" placeholder="Bike Name *">
    <input id="rentDay" placeholder="Rent per Day *" type="number">
    <label>Bike Expiry *</label>
    <input type="date" id="bikeExpiry">

    <label>Front Photo *</label><input type="file" id="imgFront" accept="image/*">
    <label>Back Photo *</label><input type="file" id="imgBack" accept="image/*">
    <label>Left Photo *</label><input type="file" id="imgLeft" accept="image/*">
    <label>Right Photo *</label><input type="file" id="imgRight" accept="image/*">

    <button class="green" onclick="submitBike()">Submit</button>
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="explore" class="page">
  <div id="bikeList"></div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="detail" class="page">
  <div class="card">
    <div class="img-slider">
      <img id="pf" alt="Front Photo">
      <img id="pb" alt="Back Photo">
      <img id="pl" alt="Left Photo">
      <img id="pr" alt="Right Photo">
    </div>
    <h3 id="dBike"></h3>
    ‚Çπ<span id="dRate"></span>/day
    <div style="margin:10px 0;display:flex;justify-content:space-between;align-items:center">
      <button class="gray" onclick="changeDays(-1)">‚àí</button>
      <b><span id="days">1</span> Day(s)</b>
      <button class="gray" onclick="changeDays(1)">+</button>
    </div>
    <p>Total: ‚Çπ<span id="totalAmt"></span></p>
    <button class="green" onclick="checkAuthAndRent()">Rent Now</button> 
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="verify" class="page">
  <div class="card">
    <h3>Rental Verification</h3>
    <p>Please complete quick verification to proceed with payment. All fields are mandatory.</p>
    
    <input id="vname" placeholder="Full Name *">
    <input id="vphone" placeholder="Mobile Number *" maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <input id="vaad" placeholder="Aadhaar Number *" maxlength="12"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <label>Aadhaar Photo *</label>
    <input type="file" id="faad" accept="image/*">

    <input id="vpan" placeholder="PAN Number *">
    <label>PAN Photo *</label>
    <input type="file" id="fpan" accept="image/*">

    <input id="vdl" placeholder="Driving Licence Number *">
    <label>DL Photo *</label>
    <input type="file" id="fdl" accept="image/*">

    <button class="green" onclick="verifyRentalData()">Proceed to Payment</button>
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="completeKYC" class="page">
  <div class="card">
    <h3>Complete KYC</h3>

    <input id="ck_name" placeholder="Full Name *">
    <input id="ck_phone" placeholder="Mobile *" maxlength="10"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <input id="ck_aadhaar" placeholder="Aadhaar Number *" maxlength="12"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <label>Aadhaar Photo *</label>
    <input type="file" id="ck_aadhaar_photo" accept="image/*">

    <input id="ck_pan" placeholder="PAN Number *">
    <label>PAN Photo *</label>
    <input type="file" id="ck_pan_photo" accept="image/*">

    <input id="ck_dl" placeholder="Driving Licence Number *">
    <label>DL Photo *</label>
    <input type="file" id="ck_dl_photo" accept="image/*">
    
    <label>Customer Live Photo *</label>
    <input type="file" id="ck_customer_photo" accept="image/*">

    <button class="green" onclick="submitCompleteKYC()">Submit KYC</button>
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="payment" class="page">
  <div class="card">
    <h3>Payment</h3>
    <p>Amount: ‚Çπ<span id="payAmount"></span></p>

    <select id="payMode" onchange="showPay()">
      <option value="">Select Payment Mode</option>
      <option value="wallet">Wallet</option>
      <option value="upi">UPI</option>
      <option value="card">Card</option>
    </select>

    <div id="walletBox" style="display:none;margin-top:8px">
      Wallet Balance: ‚Çπ<b id="walletBal"></b><br>
      <button class="green" onclick="openPage('walletRecharge')">Recharge Wallet</button>
    </div>

    <div id="upiBox" style="display:none">
      <input id="upiId" placeholder="example@upi">
    </div>

    <div id="cardBox" style="display:none">
      <input id="cardNo" placeholder="Card Number" maxlength="16"
        oninput="this.value=this.value.replace(/[^0-9]/g,'')">
      <input id="cardExp" placeholder="MM/YY">
      <input id="cardCvv" placeholder="CVV" maxlength="3"
        oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    </div>

    <button class="green" onclick="pay()">Pay Now</button>
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<div id="profile" class="page">
  <div class="card">
    <b>Logged in:</b> <span id="pPhone"></span><br>
    <b>Name:</b> <span id="pName"></span><br>
    <b>Wallet Balance:</b> ‚Çπ<span id="pWallet"></span>
  </div>

  <div class="profile-item" onclick="openWallet()">üí∞ Wallet</div>
  <div class="profile-item" onclick="openTxns()">üìú Transaction History</div>
  <div class="profile-item" onclick="openInvoices()">üßæ Invoices</div>
  <div class="profile-item" onclick="openRentals()">üèç Rental History</div>
  <div class="profile-item" onclick="openListed()">üìã Your Listed Bikes</div>

  <div class="profile-item" onclick="openCompleteKYC()">
    ‚úÖ Complete KYC :
    <b id="kycStatusText"></b>
    <div id="kycRejectReason" style="font-size:12px;"></div>
  </div>

  <div class="profile-item" onclick="openPage('subscription')">üí≥ Subscription</div>
  <div class="profile-item" onclick="openPage('addressPage')">üìç Saved Address</div>
  <div class="profile-item" onclick="openPage('securityPage')">üîí Security Deposit</div>
  <div class="profile-item" onclick="openNotifs()">üîî Notifications</div>
  <div class="profile-item" onclick="openPage('about')">‚Ñπ About Us</div>
  <div class="profile-item" onclick="openPage('support')">üìû Help & Support</div>
  <div class="profile-item" onclick="logout()" style="color:red">üö™ Logout</div>
</div>

<div id="walletPage" class="page">
  <div class="card">
    <h3>Wallet</h3>
    Balance: ‚Çπ<b id="walletShow"></b>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="walletRecharge" class="page">
  <div class="card">
    <h3>Recharge Wallet (UPI)</h3>
    <input id="reAmt" placeholder="Amount">
    <input id="reUpi" placeholder="your@upi">
    <button class="green" onclick="recharge()">Recharge</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="txnPage" class="page">
  <div class="card">
    <h3>Transactions</h3>
    <div id="txnList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="invoicePage" class="page">
  <div class="card">
    <h3>Invoices</h3>
    <div id="invList"></div>
    <button class="green" onclick="downloadInvoice()">Download Last Invoice (Print)</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="rentalHistory" class="page">
  <div class="card">
    <h3>Your Rentals</h3>
    <div id="rentalList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="listedBikes" class="page">
  <div class="card">
    <h3>Your Listed Bikes</h3>
    <div id="listedList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="subscription" class="page">
  <div class="card">
    <h3>Subscription</h3>
    <p>‚Çπ100 / month ‚Äî unlock owner contact details (demo)</p>
    <button class="green" onclick="alert('Demo only ‚Äì real subscription needs backend')">Subscribe</button>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="addressPage" class="page">
  <div class="card">
    <h3>Saved Address</h3>
    <p>Demo placeholder ‚Äì real implementation needs backend.</p>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="securityPage" class="page">
  <div class="card">
    <h3>Security Deposit</h3>
    <p>Default deposit policy managed by platform (demo).</p>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="notifPage" class="page">
  <div class="card">
    <h3>Notifications</h3>
    <div id="notifList"></div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="about" class="page">
  <div class="card" style="margin-bottom: 0;">
    <div style="background: linear-gradient(to right, #22c55e, #3b82f6); color: #fff; padding: 15px; text-align: center; border-radius: 10px 10px 0 0;">
      <h3>RentelBike</h3>
      <p style="margin: 0;">Bike Rental Platform</p>
    </div>
    <h3 style="margin-top: 15px; text-align: center;">Our Team</h3>
  </div>
  
  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px; overflow: hidden;">
      <img src="https:shivam.jpg" 
           alt="Shivam Pal" 
           style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
    </div>
    <h4 style="margin: 0;">Shivam Pal</h4>
    <p style="color: #22c55e; margin: 0;">Founder & Director</p>
    <p style="margin: 5px 0 0;">üìû 9336231919</p>
  </div>

  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px; overflow: hidden;">
      <img src="https:rishikesh.jpg" 
           alt="Rishikesh Yadav" 
           style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
    </div>
    <h4 style="margin: 0;">Rishikesh Yadav</h4>
    <p style="color: #22c55e; margin: 0;">CEO</p>
    <p style="margin: 5px 0 0;">üìû 8866271441</p>
  </div>

  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px; overflow: hidden;">
      <img src="https:utkarsh.jpg" 
           alt="Utkarsh" 
           style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
    </div>
    <h4 style="margin: 0;">Utkarsh</h4>
    <p style="color: #22c55e; margin: 0;">Co-Founder</p>
    <p style="margin: 5px 0 0;">üìû 7800300325</p>
  </div>

  <div class="card" style="text-align: center;">
    <div style="width: 100px; height: 100px; background: #eee; border-radius: 50%; margin: 0 auto 10px;">
      </div>
    <h4 style="margin: 0;">Sahil Gupta</h4>
    <p style="color: #22c55e; margin: 0;">Support Head</p>
    <p style="margin: 5px 0 0;">üìû (Not Fully Visible)</p>
  </div>
  
  <button class="gray" onclick="back()">‚Üê Back to Profile</button>
</div>

<div id="support" class="page">
  <div class="card">
    <h3>Help & Support</h3>
    <p>Email: support@rentelbike.com</p>
    <p>Phone: +91-9000000000</p>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="admin" class="page">
  <div class="card"><h3>Admin Bike Approval</h3></div>
  <div id="adminList"></div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="adminKYC" class="page">
  <div class="card">
    <h3>Admin ‚Äì KYC Review</h3>
    <p>Current Status: <b id="adminKycState"></b></p>
    <textarea id="rejectReason" placeholder="Reject reason (required for reject)"
      style="width:100%;height:70px"></textarea>
    
    <div id="kycAdminButtons">
        <button class="green" onclick="approveKYC()">‚úÖ Approve</button>
        <button class="gray" onclick="rejectKYC()">‚ùå Reject</button>
    </div>
  </div>
  <button class="gray" onclick="back()">‚Üê Back</button>
</div>

<div id="adminLogin" class="page">
  <div class="card">
    <h3>Admin Login</h3>
    <input id="adminPhone" placeholder="Admin Phone">
    <input id="adminPass" type="password" placeholder="Admin Password">
    <button class="green" onclick="adminLogin()">Login as Admin</button>
    <button class="gray" onclick="back()">‚Üê Back</button>
  </div>
</div>

<nav>
  <button onclick="openPage('home')">Home</button>
  <button onclick="openPage('explore')">Bikes</button>
  <button onclick="checkAuth('profile')">Profile</button> 
</nav>

<script>
// ====== STATE (MODIFIED: Added dummy bikes if LocalStorage is empty) ======
let stack = [];

// Load bikes from LocalStorage. If empty, load DUMMY DATA.
let bikes = JSON.parse(localStorage.getItem('bikes') || '[]');
if (bikes.length === 0) {
    bikes = [
        {
            id: 1672531200001,
            owner: "9876543210",
            ownerName: "Dummy Owner 1",
            ownerPhone: "9876543210",
            bikeName: "Hero Splendor Pro",
            rent: 350,
            expiry: "2026-12-31",
            images: {
                front: "https://via.placeholder.com/300x150?text=Splendor+Front",
                back: "https://via.placeholder.com/300x150?text=Splendor+Back",
                left: "https://via.placeholder.com/300x150?text=Splendor+Left",
                right: "https://via.placeholder.com/300x150?text=Splendor+Right"
            },
            status: 'approved' 
        },
        {
            id: 1672531200002,
            owner: "9876543210",
            ownerName: "Dummy Owner 2",
            ownerPhone: "9876543210",
            bikeName: "Honda Activa 6G",
            rent: 300,
            expiry: "2026-11-30",
            images: {
                front: "https://via.placeholder.com/300x150?text=Activa+Front",
                back: "https://via.placeholder.com/300x150?text=Activa+Back",
                left: "https://via.placeholder.com/300x150?text=Activa+Left",
                right: "https://via.placeholder.com/300x150?text=Activa+Right"
            },
            status: 'approved'
        }
    ];
    // Save dummy data to LocalStorage immediately if it was empty
    // NOTE: This might still fail if Quota is already exceeded from previous runs
    try {
        localStorage.setItem('bikes', JSON.stringify(bikes));
    } catch(e) {
        console.error("Initial dummy bike save failed:", e.message);
    }
}

let currentBikeIndex = null;
let days = 1;

let kycData = JSON.parse(localStorage.getItem('kycData') || 'null'); 

let users = JSON.parse(localStorage.getItem('users') || '[]');
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null'); 

// Wallet initialization logic adjusted slightly for guests
let wallet = currentUser && !currentUser.isGuest ? currentUser.wallet : Number(localStorage.getItem('wallet') || '5000'); 

let transactions = JSON.parse(localStorage.getItem('txns') || '[]');
let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
let rentals = JSON.parse(localStorage.getItem('rentals') || '[]');
let notifs = JSON.parse(localStorage.getItem('notifs') || '[]');

let kycStatus = localStorage.getItem("kycStatus") || "none";
let kycReason = localStorage.getItem("kycReason") || "";
let kycSubmittedAt = Number(localStorage.getItem("kycSubmittedAt") || 0);

const ADMIN_PHONE = "9336231919";      
const ADMIN_PASS  = "RB@Admin2025";     
let desiredAdminPage = null;

// ====== SAVE (MODIFIED: Added error alert for Quota Exceeded) ======
function saveAll(){
  try {
    // Only update currentUser wallet if user is logged in (not guest)
    if(currentUser && !currentUser.isGuest) {
        const userIndex = users.findIndex(u => u.phone === currentUser.phone);
        if (userIndex !== -1) {
            users[userIndex] = currentUser;
        }
    }
    
    localStorage.setItem('bikes', JSON.stringify(bikes));
    localStorage.setItem('txns', JSON.stringify(transactions));
    localStorage.setItem('invoices', JSON.stringify(invoices));
    localStorage.setItem('rentals', JSON.stringify(rentals));
    localStorage.setItem('notifs', JSON.stringify(notifs));
    localStorage.setItem('kycStatus', kycStatus);
    localStorage.setItem('kycReason', kycReason);
    localStorage.setItem('kycSubmittedAt', kycSubmittedAt);
    localStorage.setItem('kycData', JSON.stringify(kycData)); 
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    // Fallback for guest wallet
    if(!currentUser || currentUser.isGuest) {
        localStorage.setItem('wallet', wallet);
    }
    
  } catch(e) {
    if (e.name === 'QuotaExceededError') {
      alert("Error reading files: Failed to execute 'setItem' on 'Storage': Setting the value of 'bikes' exceeded the quota. This issue can only be resolved by clearing your browser's Local Storage for this site. You may lose current unsaved data.");
      console.error(e.message);
    } else {
      alert("Error saving data: " + e.message);
      console.error(e.message);
    }
  }
}

function addNotif(msg){
  notifs.push({msg,date:new Date().toLocaleString()});
  saveAll();
}

// ====== BASE64 UTILITY FUNCTION (Image handling) ======
function getBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// ====== PAGE NAVIGATION & AUTHENTICATION ======

function isLoggedIn() {
    return currentUser && !currentUser.isGuest;
}

function toggleNav(show) {
    if (show) {
        document.body.classList.add('logged-in');
    } else {
        document.body.classList.remove('logged-in');
    }
}

function checkAuth(targetPage){
    if (isLoggedIn()) {
        openPage(targetPage);
    } else {
        alert("Please Login or Sign Up to access this feature.");
        stack = [];
        openPage('login');
    }
}

function checkAuthAndRent(){
    if (isLoggedIn()) {
        // If user is logged in, check if full KYC is approved
        if (kycStatus === 'approved') {
            openPage('verify'); // Quick verification for rental
        } else if (kycStatus === 'pending') {
            alert("Your KYC is under review. Please wait for approval before renting.");
        } else {
            if(confirm("KYC is required for rental. Do you want to submit your documents now?")){
                openPage('completeKYC');
            } else {
                // Cancel rental
            }
        }
    } else {
        alert("Please Login or Sign Up to rent a bike.");
        stack = [];
        openPage('login');
    }
}


function openPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  
  // Clear stack if we are on the initial entry pages
  if (id === 'login' || id === 'signupForm') {
      stack = [];
  }
  stack.push(id);


  if (id === 'login' || id === 'signupForm') {
      toggleNav(false);
  } else if (id === 'home' || id === 'explore' || id === 'profile') {
      toggleNav(true); 
  }

  // Only render bikes when going to the explore page
  if(id === 'explore') renderBikes(); 

  if(id === 'profile'){
    if(currentUser){
        pPhone.innerText = currentUser.phone || (currentUser.isGuest ? 'Guest' : 'N/A');
        pName.innerText = currentUser.name || (currentUser.isGuest ? 'Guest' : 'N/A');
        pWallet.innerText = currentUser.wallet !== undefined ? currentUser.wallet.toFixed(2) : wallet.toFixed(2);
        
        kycStatusText.innerText = kycStatus.toUpperCase();
        kycRejectReason.innerText = kycStatus === 'rejected' ? `Reason: ${kycReason}` : '';
        kycRejectReason.style.display = kycStatus === 'rejected' ? 'block' : 'none';
        
    } else {
         pPhone.innerText = 'N/A';
         pName.innerText = 'N/A';
         pWallet.innerText = wallet.toFixed(2);
         kycStatusText.innerText = 'N/A';
    }
  }

  if(id === 'admin') renderAdminBikes();
  if(id === 'adminKYC') renderAdminKYC();
  
  if(id === 'walletPage') walletShow.innerText = (currentUser ? currentUser.wallet : wallet).toFixed(2);
  if(id === 'txnPage') renderTxns();
  if(id === 'rentalHistory') renderRentals();
  if(id === 'listedBikes') renderListedBikes();
  if(id === 'notifPage') renderNotifs();
}

function back(){
  stack.pop();
  let prevPageId = stack.pop(); 
  if(prevPageId) openPage(prevPageId);
  else openPage('home'); 
}

// ====== AUTH/LOGIN/SIGNUP ======

function signup() {
    const phone = sphone.value;
    const pass = spass.value;
    const name = sname.value;

    if (!phone || !pass || !name) {
        alert("Please fill in required fields (Name, Mobile, Password).");
        return;
    }

    if (users.find(u => u.phone === phone)) {
        alert("User already exists. Please login.");
        return;
    }

    const newUser = {
        phone: phone,
        password: pass,
        name: name,
        wallet: 0, 
        listedBikes: [],
        txns: [],
        rentals: []
    };
    users.push(newUser);
    // Don't log in automatically, force login after signup
    saveAll(); 
    alert("Account created successfully! Please login to continue.");
    openPage('login');
}

function login() {
    const phone = lphone.value;
    const pass = lpass.value;

    const user = users.find(u => u.phone === phone && u.password === pass);

    if (user) {
        currentUser = user;
        saveAll();
        alert("Login Successful!");
        openPage('home');
    } else {
        alert("Invalid mobile or password.");
    }
}

function guestLogin() {
    currentUser = {
        isGuest: true,
        name: "Guest",
        phone: "0000000000",
        wallet: wallet
    };
    saveAll();
    alert("Logged in as Guest. Some features are restricted.");
    openPage('home');
}

function logout() {
    currentUser = null;
    stack = [];
    saveAll(); 
    alert("Logged out.");
    openPage('login'); 
    toggleNav(false);
}

// ====== ADMIN LOGIC ======

let targetAdminPage = '';

function openAdminLogin(target){
    targetAdminPage = target;
    openPage('adminLogin');
}

function adminLogin(){
    if(adminPhone.value === ADMIN_PHONE && adminPass.value === ADMIN_PASS){
        alert('Admin Login Successful');
        openPage(targetAdminPage);
    } else {
        alert('Invalid Admin Credentials');
    }
}

// ====== KYC LOGIC (UPDATED VALIDATION AND DATA) ======
function openCompleteKYC(){
    if (kycStatus === 'approved') {
        alert("Your KYC is already approved.");
        return;
    }
    ck_name.value = currentUser.name || '';
    ck_phone.value = currentUser.phone || '';
    openPage('completeKYC');
}

// MODIFIED: Added validation for all 4 files, including customer photo
async function submitCompleteKYC(){
    const name = ck_name.value.trim();
    const phone = ck_phone.value.trim();
    const aadhaar = ck_aadhaar.value.trim();
    
    // Get file inputs
    const aadhaarFile = ck_aadhaar_photo.files[0];
    const panFile = ck_pan_photo.files[0];
    const dlFile = ck_dl_photo.files[0];
    const customerPhotoFile = ck_customer_photo.files[0]; 

    // --- UPDATED VALIDATION START ---
    if (!name || !phone || !aadhaar) {
        alert("Please enter Full Name, Mobile, and Aadhaar Number.");
        return;
    }
    if (!ck_pan.value.trim() || !ck_dl.value.trim()) {
        alert("Please enter PAN Number and Driving Licence Number.");
        return;
    }
    // Check if all 4 files are uploaded
    if (!aadhaarFile || !panFile || !dlFile || !customerPhotoFile) { 
        alert("All KYC documents (Aadhaar Photo, PAN Photo, DL Photo, and Customer Live Photo) must be uploaded.");
        return;
    }
    // --- UPDATED VALIDATION END ---


    try {
        // Since we are not using Base64 for the rental flow, 
        // we'll just check that files exist and then proceed with status update
        // (In a real app, this would upload the files to a server)

        kycData = {
            name, phone, aadhaar,
            // Images are not stored in localStorage due to size limits
        };
        kycStatus = 'pending';
        kycSubmittedAt = Date.now();
        kycReason = "";
        
        saveAll();
        addNotif("KYC documents submitted for review.");
        alert("KYC submitted successfully. Status is now PENDING.");
        openPage('profile');
    } catch(e) {
        alert("Error reading files/saving data: " + e.message);
    }
}

// MODIFIED: Added customer photo display
function renderAdminKYC(){
    const kycPage = document.getElementById('adminKYC');
    const existingDocs = kycPage.querySelector('.card:nth-child(2)');
    if (existingDocs) existingDocs.remove();
    
    document.getElementById('kycAdminButtons').style.display = 'none';
    document.getElementById('rejectReason').style.display = 'none';

    if(kycData){
        adminKycState.innerHTML = `Submitted by ${kycData.name} (${kycData.phone}) on ${new Date(kycSubmittedAt).toLocaleString()}. Status: <b style="color: ${kycStatus === 'pending' ? 'blue' : (kycStatus === 'approved' ? 'green' : 'red')}">${kycStatus.toUpperCase()}</b>`;
        
        // Simplified image placeholders since we stopped storing base64 for submission
        let html = `<div class="card">
            <h4>Documents for Review:</h4>
            <p>Aadhaar: ${kycData.aadhaar}</p>
            <div class="img-slider admin-img-row">
                <img src="https://via.placeholder.com/60x60?text=Aadhaar+Uploaded" alt="Aadhaar">
                <img src="https://via.placeholder.com/60x60?text=PAN+Uploaded" alt="PAN">
                <img src="https://via.placeholder.com/60x60?text=DL+Uploaded" alt="DL">
                <img src="https://via.placeholder.com/60x60?text=Customer+Photo" alt="Customer Photo">
            </div>
            ${kycStatus === 'rejected' ? `<p style="color:red; font-weight:bold;">Rejection Reason: ${kycReason}</p>` : ''}
            </div>`;
        kycPage.insertAdjacentHTML('beforeend', html);

        if (kycStatus === 'pending') {
            document.getElementById('kycAdminButtons').style.display = 'block';
            document.getElementById('rejectReason').style.display = 'block';
        } else {
            document.getElementById('rejectReason').value = ''; 
        }
        
    } else {
        adminKycState.innerText = "No KYC currently submitted.";
    }
}

function approveKYC(){
    if(kycStatus !== 'pending'){
        alert('KYC is not in PENDING state to be approved.');
        return;
    }
    kycStatus = 'approved';
    kycReason = '';
    saveAll();
    addNotif("Congratulations! Your KYC has been approved.");
    alert('KYC Approved.');
    renderAdminKYC(); 
}

function rejectKYC(){
    const reason = rejectReason.value.trim();
    if(kycStatus !== 'pending'){
        alert('KYC is not in PENDING state to be rejected.');
        return;
    }
    if(!reason){
        alert('Rejection reason is mandatory.');
        return;
    }
    kycStatus = 'rejected';
    kycReason = reason;
    saveAll();
    addNotif(`Your KYC submission was rejected. Reason: ${reason}`);
    alert('KYC Rejected.');
    renderAdminKYC(); 
}


// ====== BIKE LISTING LOGIC (UPDATED VALIDATION) ======

// MODIFIED: Added validation for all 4 files
async function submitBike(){
    const name = ownerName.value;
    const phone = ownerPhone.value;
    const bike = bikeName.value;
    const rent = rentDay.value;
    const expiry = bikeExpiry.value;

    // Check if the input elements are available before accessing files
    if (!imgFront || !imgBack || !imgLeft || !imgRight) {
         alert("Error: File input elements are missing in the HTML.");
         return;
    }

    const files = [imgFront.files[0], imgBack.files[0], imgLeft.files[0], imgRight.files[0]];

    // --- UPDATED VALIDATION START ---
    if (!name || !phone || !bike || !rent || !expiry) {
        alert("All fields (Owner Name, Phone, Bike Name, Rent, Expiry) are required.");
        return;
    }
    // Check if exactly 4 files are uploaded
    if (files.some(f => !f) || files.length !== 4) {
        alert("All four bike photos (Front, Back, Left, Right) are mandatory.");
        return;
    }
    // --- UPDATED VALIDATION END ---


    try {
        const images = await Promise.all(files.map(getBase64));

        const newBike = {
            id: Date.now(),
            owner: currentUser.phone,
            ownerName: name,
            ownerPhone: phone,
            bikeName: bike,
            rent: Number(rent),
            expiry: expiry,
            images: {
                front: images[0],
                back: images[1],
                left: images[2],
                right: images[3]
            },
            status: 'pending' 
        };
        bikes.push(newBike);
        currentUser.listedBikes.push(newBike.id);
        saveAll();
        addNotif(`Bike '${bike}' submitted for approval.`);
        alert("Bike submitted for admin approval.");
        openPage('home');
    } catch(e) {
        // This often catches the Local Storage Quota Exceeded error due to large Base64 strings
        alert("Error reading files/saving data: " + e.message + ". Try using smaller image files.");
    }
}

function renderAdminBikes(){
    adminList.innerHTML = '';
    
    if (!bikes || !Array.isArray(bikes)) {
        adminList.innerHTML = '<div class="card">Error: Bike data is corrupted. Please contact support.</div>';
        return;
    }
    
    const pendingBikes = bikes.filter(b => b.status === 'pending');

    if(pendingBikes.length === 0){
        adminList.innerHTML = '<div class="card">No bikes pending approval.</div>';
        return;
    }

    pendingBikes.forEach(b => {
        const bikeCard = `
            <div class="card">
                <b>${b.bikeName}</b> (‚Çπ${b.rent}/day)<br>
                <small>Owner: ${b.ownerName} | Phone: ${b.ownerPhone}</small>
                <div class="img-slider admin-img-row">
                    <img src="${b.images.front}" alt="Front">
                    <img src="${b.images.back}" alt="Back">
                    <img src="${b.images.left}" alt="Left">
                    <img src="${b.images.right}" alt="Right">
                </div>
                <button class="green" onclick="approveBike(${b.id})">‚úÖ Approve</button>
                <button class="gray" onclick="rejectBike(${b.id})">‚ùå Reject</button>
            </div>
        `;
        adminList.insertAdjacentHTML('beforeend', bikeCard);
    });
}

function findBike(id) {
    return bikes.find(b => b.id === id);
}

function approveBike(id){
    const bike = findBike(id);
    if(bike){
        bike.status = 'approved';
        saveAll();
        addNotif(`Your bike '${bike.bikeName}' has been approved and is now listed.`);
        alert('Bike Approved.');
        renderAdminBikes();
        renderBikes(); 
    }
}

function rejectBike(id){
    const bike = findBike(id);
    if(bike){
        bike.status = 'rejected';
        saveAll();
        addNotif(`Your bike '${bike.bikeName}' submission was rejected.`);
        alert('Bike Rejected.');
        renderAdminBikes();
    }
}

// ====== EXPLORE & DETAIL FUNCTIONS (FIXED: Moved logic inside renderBikes) ======

function renderBikes(){
    bikeList.innerHTML = '';
    
    if (!bikes || !Array.isArray(bikes)) {
        bikeList.innerHTML = '<div class="card">Error: Bike data is corrupted.</div>';
        return;
    }
    
    const approvedBikes = bikes.filter(b => b.status === 'approved');

    if(approvedBikes.length === 0){
        bikeList.innerHTML = '<div class="card">No bikes currently available for rent.</div>';
        return;
    }

    approvedBikes.forEach(b => {
        const bikeCard = `
            <div class="card" onclick="showDetail(${b.id})">
                <img src="${b.images.front}" style="width:100%; height:150px; object-fit:cover; border-radius:10px; margin-bottom:8px;">
                <b>${b.bikeName}</b><br>
                ‚Çπ${b.rent}/day
            </div>
        `;
        bikeList.insertAdjacentHTML('beforeend', bikeCard);
    });
}

function showDetail(id){
    currentBikeIndex = bikes.findIndex(b => b.id === id);
    const bike = bikes[currentBikeIndex];
    if(bike){
        dBike.innerText = bike.bikeName;
        dRate.innerText = bike.rent;
        pf.src = bike.images.front;
        pb.src = bike.images.back;
        pl.src = bike.images.left;
        pr.src = bike.images.right;
        days = 1;
        updateRentalCost();
        openPage('detail');
    }
}

function changeDays(change){
    days = Math.max(1, days + change);
    days = Math.min(30, days); 
    updateRentalCost();
}

function updateRentalCost(){
    const bike = bikes[currentBikeIndex];
    const total = days * bike.rent;
    document.getElementById('days').innerText = days;
    document.getElementById('totalAmt').innerText = total.toFixed(2);
}

// ====== PAYMENT & RENTAL (Simplified logic) ======

/** * NEW: Enforces mandatory fields for Rental Verification.
 * After passing the check, it calls goPayment() to proceed.
 */
function verifyRentalData() {
    const name = vname.value.trim();
    const phone = vphone.value.trim();
    const aad = vaad.value.trim();
    const pan = vpan.value.trim();
    const dl = vdl.value.trim();
    
    const faadFile = faad.files[0];
    const fpanFile = fpan.files[0];
    const fdlFile = fdl.files[0];

    let missingFields = [];
    
    if (!name) missingFields.push("Full Name");
    if (!phone || phone.length !== 10) missingFields.push("Mobile Number (10 digits)");
    if (!aad || aad.length !== 12) missingFields.push("Aadhaar Number (12 digits)");
    if (!pan) missingFields.push("PAN Number");
    if (!dl) missingFields.push("Driving Licence Number");
    if (!faadFile) missingFields.push("Aadhaar Photo");
    if (!fpanFile) missingFields.push("PAN Photo");
    if (!fdlFile) missingFields.push("DL Photo");

    if (missingFields.length > 0) {
        alert("Please fill all mandatory fields to proceed:\n\n- " + missingFields.join('\n- '));
        return;
    }
    
    // If all checks pass, proceed to payment logic
    goPayment();
}

function goPayment(){
    // Quick verification logic before payment (Skipped for simplicity, assuming user is logged in/KYC checked)
    const total = Number(document.getElementById('totalAmt').innerText);
    payAmount.innerText = total.toFixed(2);
    openPage('payment');
}

function showPay(){
    walletBox.style.display = payMode.value === 'wallet' ? 'block' : 'none';
    upiBox.style.display = payMode.value === 'upi' ? 'block' : 'none';
    cardBox.style.display = payMode.value === 'card' ? 'block' : 'none';
    walletBal.innerText = (currentUser ? currentUser.wallet : wallet).toFixed(2);
}

function pay(){
    const mode = payMode.value;
    const totalAmount = Number(payAmount.innerText);

    if (mode === 'wallet') {
        const currentWallet = currentUser ? currentUser.wallet : wallet;
        if (currentWallet < totalAmount) {
            alert("Insufficient wallet balance.");
            return;
        }
        if(currentUser){
            currentUser.wallet -= totalAmount;
        } else {
            wallet -= totalAmount;
        }
        processRental(totalAmount, 'Wallet');
    } else if (mode === 'upi' || mode === 'card') {
        if ((mode === 'upi' && !upiId.value) || (mode === 'card' && (!cardNo.value || !cardExp.value || !cardCvv.value))) {
            alert("Please complete payment details.");
            return;
        }
        processRental(totalAmount, mode.toUpperCase());
    } else {
        alert("Please select a payment mode.");
    }
}

function processRental(amount, mode){
    const bike = bikes[currentBikeIndex];
    const user = currentUser;

    const txn = {
        id: Date.now() + Math.random(),
        type: 'debit',
        amount: amount,
        description: `Bike rental for ${bike.bikeName} (${days} days)`,
        mode: mode,
        date: new Date().toLocaleString()
    };
    transactions.push(txn);
    user.txns.push(txn);
    
    const rental = {
        id: Date.now(),
        bikeName: bike.bikeName,
        days: days,
        amount: amount,
        ownerPhone: bike.ownerPhone,
        startDate: new Date().toLocaleDateString(),
        date: new Date().toLocaleString()
    };
    rentals.push(rental);
    user.rentals.push(rental);

    const invoice = {
        id: Date.now() + Math.random() + 1,
        amount: amount,
        date: new Date().toLocaleString(),
        description: `RentelBike Rental Invoice for ${bike.bikeName}`
    };
    invoices.push(invoice);

    saveAll();
    addNotif(`Rental successful! You have rented ${bike.bikeName} for ${days} days.`);
    alert(`Payment of ‚Çπ${amount.toFixed(2)} successful via ${mode}. Bike rented!`);
    openPage('home');
}


// ====== PROFILE SUB-MENU LOGIC (Helper functions) ======

function openWallet(){ openPage('walletPage'); }
function openTxns(){ openPage('txnPage'); }
function openInvoices(){ openPage('invoicePage'); }
function openRentals(){ openPage('rentalHistory'); }
function openListed(){ openPage('listedBikes'); }
function openNotifs(){ openPage('notifPage'); }


function renderTxns(){
    txnList.innerHTML = '';
    // Use user's own txns array for profile rendering
    const userTxns = (currentUser && currentUser.txns ? currentUser.txns.slice().reverse() : []); 

    if(userTxns.length === 0){
        txnList.innerHTML = '<div class="card">No transactions yet.</div>';
        return;
    }

    userTxns.forEach(t => {
        const color = t.type === 'credit' ? 'green' : 'red';
        const sign = t.type === 'credit' ? '+' : '-';
        const txnCard = `
            <div class="card" style="border-left: 5px solid ${color};">
                <b>${t.description}</b><br>
                <small>${t.date}</small>
                <p style="color:${color}; margin:5px 0 0;">${sign} ‚Çπ${t.amount.toFixed(2)} (${t.mode})</p>
            </div>
        `;
        txnList.insertAdjacentHTML('beforeend', txnCard);
    });
}

function renderRentals(){
    rentalList.innerHTML = '';
    const userRentals = (currentUser && currentUser.rentals ? currentUser.rentals.slice().reverse() : []);

    if(userRentals.length === 0){
        rentalList.innerHTML = '<div class="card">No rental history.</div>';
        return;
    }

    userRentals.forEach(r => {
        const rentalCard = `
            <div class="card">
                <b>${r.bikeName}</b><br>
                <p style="margin:5px 0;">Duration: ${r.days} Day(s) | Amount: ‚Çπ${r.amount.toFixed(2)}</p>
                <small>Rented on: ${r.date}</small>
            </div>
        `;
        rentalList.insertAdjacentHTML('beforeend', rentalCard);
    });
}

function renderListedBikes(){
    listedList.innerHTML = '';
    
    // Filter bikes owned by the current user
    const userListedBikes = bikes.filter(b => currentUser && b.owner === currentUser.phone).reverse();

    if(userListedBikes.length === 0){
        listedList.innerHTML = '<div class="card">You have not listed any bikes yet.</div>';
        return;
    }

    userListedBikes.forEach(b => {
        const statusColor = b.status === 'approved' ? '#22c55e' : (b.status === 'pending' ? '#3b82f6' : '#64748b');
        const bikeCard = `
            <div class="card">
                <b>${b.bikeName}</b> (‚Çπ${b.rent}/day)<br>
                <small style="color:${statusColor}">Status: ${b.status.toUpperCase()}</small>
            </div>
        `;
        listedList.insertAdjacentHTML('beforeend', bikeCard);
    });
}

function renderNotifs(){
    notifList.innerHTML = '';
    const userNotifs = notifs.slice().reverse();

    if(userNotifs.length === 0){
        notifList.innerHTML = '<div class="card">No notifications.</div>';
        return;
    }

    userNotifs.forEach(n => {
        const notifCard = `
            <div class="card">
                <b>${n.msg}</b><br>
                <small>${n.date}</small>
            </div>
        `;
        notifList.insertAdjacentHTML('beforeend', notifCard);
    });
}

function downloadInvoice(){
    alert("Invoice download initiated (Demo feature).");
}

function recharge(){
    const amount = Number(reAmt.value);
    const upi = reUpi.value.trim();

    if (amount <= 0 || !upi) {
        alert("Please enter a valid amount and UPI ID.");
        return;
    }
    
    // Update the correct wallet
    if(currentUser){
        currentUser.wallet += amount;
    } else {
        wallet += amount;
    }

    const txn = {
        id: Date.now() + Math.random(),
        type: 'credit',
        amount: amount,
        description: `Wallet Recharge via UPI: ${upi}`,
        mode: 'UPI',
        date: new Date().toLocaleString()
    };
    
    // Add transaction to global array and user array
    transactions.push(txn);
    if(currentUser && currentUser.txns) currentUser.txns.push(txn);
    
    saveAll();
    addNotif(`Wallet recharged successfully with ‚Çπ${amount.toFixed(2)}.`);
    alert(`Wallet recharged successfully with ‚Çπ${amount.toFixed(2)}.`);
    openPage('walletPage');
}

// Initial Setup
if (!currentUser) {
    toggleNav(false);
    openPage('login');
} else {
    toggleNav(true);
    openPage('home'); 
}
</script>
</body>
</html>
